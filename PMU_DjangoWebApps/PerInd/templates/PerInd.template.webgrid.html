{% extends 'template.base.html' %}
<!-- Will contain the template for the WebGrid html -->
{% block content %}
<style>
    .dropdown, .content {
        margin: 2.5px;
    }

    .scrollable-menu {
        {% comment %} height: auto; {% endcomment %}
        max-height: 200px;
        overflow-y: auto;
        {% comment %} overflow-x: hidden;
        min-width: 100% !important;
        background-attachment: local, local, scroll, scroll; {% endcomment %}
    }

    .dropdown-item {
        {% comment %} white-space: normal; {% endcomment %}
    }
</style>

<div class="navbar navbar-expand-lg">
    <!-- Collapse buttons -->
    <div>
        <a class="btn btn-primary" data-toggle="collapse" href="#collapseExample" aria-expanded="false" aria-controls="collapseExample">
            Instructions:
        </a>
    </div>
    <!-- / Collapse buttons -->
    <!-- Collapsible element -->
    <div class="collapse" id="collapseExample">
        <div class="mt-3">
            1. The column in blue is editable!<br>
            &nbsp;&nbsp;&nbsp;&nbsp;* Double click on any of the cell to enter Edit Mode.<br>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* Once you are done, press 'Enter' key to save the value, or press 'ESC' key to cancel your edit.<br>
            2. The blue column names are sortable, click it to sort it by Ascending or Descending.
        </div>
    <!-- / Collapsible element -->
    </div>
    <div><br>Permission: {% for each in category_permissions %}{{each}}, {% endfor %}</div>
    <!-- <div class="status_info led_light">Database Status: {% if req_success %}<div class='led_green'></div>{% else %}<div class='led_red'></div>{% endif %}</div> -->
    <div class="status_info err_msg">{% if not req_success %} Error: '{{ err_msg }}'<br>Please try reloading the page again!<br>Please contact ykuang@dot.nyc.gov with a screenshot if this error continues. {% else %}{% endif %}</div>
</div>

{% comment %}
<div>CURRENT CONTEXT PARAM: {{ ctx_pagination_param }}</div>
<div>Title Filters: {% for each in ctx_title_list_filter %}{{each}}, {% endfor %}</div>
<div>Calendar Year Filters: {% for each in ctx_yr_list_filter %}{{each}}, {% endfor %}</div>
<div>FY Year Filters: {% for each in ctx_fy_list_filter %}{{each}}, {% endfor %}</div>
<div>Month Filters: {% for each in ctx_mn_list_filter %}{{each}}, {% endfor %}</div>
{% endcomment %}
<!--Dropdown-->
<div class="container btn-group">

    <!-- Title Dropdown -->
    <div class="dropdown">
        <button class="btn btn-secondary dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            Title
        </button>
        <form>
            <div class="dropdown-menu" aria-labelledby="dropdownMenuButton1">
                <div class="scrollable-menu">
                    {% for each in uniq_titles %}
                        <a class="dropdown-item"><input type="checkbox" name="TitleListFilter" value="{{ each.indicator__indicator_title }}" {% if each.indicator__indicator_title in ctx_title_list_filter %}checked{% endif %} /> {{ each.indicator__indicator_title }}</a>
                    {% endfor %}

                    <!-- Exists to keep current YYYY filter context alive when submit button is click for this form -->
                    {% for each in uniq_years %}
                        {% if each.year_month__yyyy|stringformat:"i" in ctx_yr_list_filter %}
                            <input type="hidden" name="YYYYListFilter" value="{{ each.year_month__yyyy }}" />
                        {% endif %}
                    {% endfor %}
                    <!-- Exists to keep current MM filter context alive when submit button is click for this form -->
                    {% for each in uniq_months %}
                        {% if each.year_month__mm|stringformat:"i" in ctx_mn_list_filter %}
                            <input type="hidden" name="MMListFilter" value="{{ each.year_month__mm }}" />
                        {% endif %}
                    {% endfor %}
                    <!-- Exists to keep current Fiscal Year filter context alive when submit button is click for this form -->
                    {% for each in uniq_fiscal_years %}
                        {% if each|stringformat:"i" in ctx_fy_list_filter %}
                            <input type="hidden" name="FiscalYYYYListFilter" value="{{ each }}" />
                        {% endif %}
                    {% endfor %}
                    <input type="hidden" name="SortBy" value="{{ sort_by }}" />
                    <input type="hidden" name="SortDir" value="{{ sort_dir }}" />
                </div>
                <div class="dropdown-divider"></div>
                <div>
                    <button type="submit" class="btn btn-info">Filter</button>
                </div>
            </div>
        </form>
    </div>

    {% comment %}
    <!-- Year Dropdown -->
    <div class="dropdown">
        <button class="btn btn-secondary dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            Calendar Year
        </button>
        <form>
            <div class="dropdown-menu" aria-labelledby="dropdownMenuButton2">
                {% for each in uniq_years %}
                    <a class="dropdown-item"><input type="checkbox" name="YYYYListFilter" value="{{ each.year_month__yyyy }}" {% if each.year_month__yyyy|stringformat:"i" in ctx_yr_list_filter %}checked{% endif %} /> {{ each.year_month__yyyy }}</a> <!-- |stringformat:"i" is needed here to convert the int to a string. "i" stands for string, take a look here https://docs.python.org/2/library/stdtypes.html#string-formatting-operations -->
                {% endfor %}

                <!-- Exists to keep current Title filter context alive when submit button is click for this form -->
                {% for each in uniq_titles %}
                    {% if each.indicator__indicator_title in ctx_title_list_filter %}
                        <input type="hidden" name="TitleListFilter" value="{{ each.indicator__indicator_title }}" />
                    {% endif %}
                {% endfor %}
                <!-- Exists to keep current MM filter context alive when submit button is click for this form -->
                {% for each in uniq_months %}
                    {% if each.year_month__mm|stringformat:"i" in ctx_mn_list_filter %}
                        <input type="hidden" name="MMListFilter" value="{{ each.year_month__mm }}" />
                    {% endif %}
                {% endfor %}
                <!-- Exists to keep current Fiscal Year filter context alive when submit button is click for this form -->
                {% for each in uniq_fiscal_years %}
                    {% if each|stringformat:"i" in ctx_fy_list_filter %}
                        <input type="hidden" name="FiscalYYYYListFilter" value="{{ each }}" />
                    {% endif %}
                {% endfor %}
                <input type="hidden" name="SortBy" value="{{ sort_by }}" />
                <input type="hidden" name="SortDir" value="{{ sort_dir }}" />
                <button type="submit" class="btn btn-info">Filter</button>
            </div>
        </form>
    </div>
    {% endcomment %}

    <!-- Fiscal Year Dropdown -->
    <div class="dropdown">
        <button class="btn btn-secondary dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            Fiscal Year
        </button>
        <form>
            <div class="dropdown-menu" aria-labelledby="dropdownMenuButton2">
                <div class="scrollable-menu">
                    {% for each in uniq_fiscal_years %}
                        <a class="dropdown-item"><input type="checkbox" name="FiscalYYYYListFilter" value="{{ each }}" {% if each|stringformat:"i" in ctx_fy_list_filter %}checked{% endif %} /> {{ each }}</a>
                    {% endfor %}

                    <!-- Exists to keep current Title filter context alive when submit button is click for this form -->
                    {% for each in uniq_titles %}
                        {% if each.indicator__indicator_title in ctx_title_list_filter %}
                            <input type="hidden" name="TitleListFilter" value="{{ each.indicator__indicator_title }}" />
                        {% endif %}
                    {% endfor %}
                    <!-- Exists to keep current YYYY filter context alive when submit button is click for this form -->
                    {% for each in uniq_years %}
                        {% if each.year_month__yyyy|stringformat:"i" in ctx_yr_list_filter %}
                            <input type="hidden" name="YYYYListFilter" value="{{ each.year_month__yyyy }}" />
                        {% endif %}
                    {% endfor %}
                    <!-- Exists to keep current MM filter context alive when submit button is click for this form -->
                    {% for each in uniq_months %}
                        {% if each.year_month__mm|stringformat:"i" in ctx_mn_list_filter %}
                            <input type="hidden" name="MMListFilter" value="{{ each.year_month__mm }}" />
                        {% endif %}
                    {% endfor %}
                    <input type="hidden" name="SortBy" value="{{ sort_by }}" />
                    <input type="hidden" name="SortDir" value="{{ sort_dir }}" />
                </div>
                <div class="dropdown-divider"></div>
                <div>
                    <button type="submit" class="btn btn-info">Filter</button>
                </div>
            </div>
        </form>
    </div>

    <!-- Month Dropdown -->
    <div class="dropdown">
        <button class="btn btn-secondary dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            Month
        </button>
        <form>
            <div class="dropdown-menu" aria-labelledby="dropdownMenuButton3">
                <div class="scrollable-menu">
                    {% for each in uniq_months %}
                    <a class="dropdown-item">
                        <input type="checkbox" name="MMListFilter" value="{{ each.year_month__mm }}" {% if each.year_month__mm|stringformat:"i" in ctx_mn_list_filter %}checked{% endif %} />
                        {% if each.year_month__mm == 1 %}
                        Jan
                        {% elif each.year_month__mm == 2 %}
                        Feb
                        {% elif each.year_month__mm == 3 %}
                        Mar
                        {% elif each.year_month__mm == 4 %}
                        Apr
                        {% elif each.year_month__mm == 5 %}
                        May
                        {% elif each.year_month__mm == 6 %}
                        Jun
                        {% elif each.year_month__mm == 7 %}
                        Jul
                        {% elif each.year_month__mm == 8 %}
                        Aug
                        {% elif each.year_month__mm == 9 %}
                        Sep
                        {% elif each.year_month__mm == 10 %}
                        Oct
                        {% elif each.year_month__mm == 11 %}
                        Nov
                        {% elif each.year_month__mm == 12 %}
                        Dec
                        {% else %}
                        Unrecognized Month
                        {% endif %}
                    </a>
                    {% endfor %}

                    <!-- Exists to keep current Title filter context alive when submit button is click for this form -->
                    {% for each in uniq_titles %}
                        {% if each.indicator__indicator_title in ctx_title_list_filter %}
                            <input type="hidden" name="TitleListFilter" value="{{ each.indicator__indicator_title }}" />
                        {% endif %}
                    {% endfor %}
                    <!-- Exists to keep current YYYY filter context alive when submit button is click for this form -->
                    {% for each in uniq_years %}
                        {% if each.year_month__yyyy|stringformat:"i" in ctx_yr_list_filter %}
                            <input type="hidden" name="YYYYListFilter" value="{{ each.year_month__yyyy }}" />
                        {% endif %}
                    {% endfor %}
                    <!-- Exists to keep current Fiscal Year filter context alive when submit button is click for this form -->
                    {% for each in uniq_fiscal_years %}
                        {% if each|stringformat:"i" in ctx_fy_list_filter %}
                            <input type="hidden" name="FiscalYYYYListFilter" value="{{ each }}" />
                        {% endif %}
                    {% endfor %}
                    <input type="hidden" name="SortBy" value="{{ sort_by }}" />
                    <input type="hidden" name="SortDir" value="{{ sort_dir }}" />
                </div>
                <div class="dropdown-divider"></div>
                <div>
                    <button type="submit" class="btn btn-info">Filter</button>
                </div>
            </div>
        </form>
    </div>

    <!-- Clear All Dropdown Button -->
    <div class="dropdown">
        <a class="btn btn-default" type="button" aria-haspopup="true" aria-expanded="false" href="?">
            Clear all filters and sorts
        </a>
    </div>
</div>
<!--End Dropdown-->
<!--WebGrid-->
<div>
    <table class="table table-striped table-hover">
        <thead>
            <tr>
                <th>
                    <a class="blue-text" href="?{{ title_sort_anchor_GET_param }}">
                        Indicator Title
                        {% if sort_by == 'indicator__indicator_title' and sort_dir == 'asc' %}
                            <i class="fas fa-caret-up"></i>
                        {% elif sort_by == 'indicator__indicator_title' and sort_dir == 'desc' %}
                            <i class="fas fa-caret-down"></i>
                        {% endif %}
                    </a>
                </th>

                <th>
                    <!-- fy_yyyy_sort_anchor_GET_param's backend is sorting by Calendar Year -->
                    <!-- It's okay to use YYYY as the sort fiscal year here, since Fiscal Year doesn't actually exists in the database model, it's hard to do the sort. And since Fiscal Year is alwaya a fix offset from Calendar Year, sorting by Calendar Year will sort the Fiscal Year correctly. In effect, we are sorting Fiscal Year by proxy(proxy through sorting Calendar Year) -->
                    <a class="blue-text" href="?{{ fy_yyyy_sort_anchor_GET_param }}">
                        Fiscal Year
                        {% if sort_by == 'year_month__fiscal_yyyy' and sort_dir == 'asc' %}
                            <i class="fas fa-caret-up"></i>
                        {% elif sort_by == 'year_month__fiscal_yyyy' and sort_dir == 'desc' %}
                            <i class="fas fa-caret-down"></i>
                        {% endif %}
                    </a>
                </th>

                {% comment %}
                <th>
                    <a class="blue-text" href="?{{ yyyy_sort_anchor_GET_param }}">
                        Calendar Year
                        {% if sort_by == 'year_month__yyyy' and sort_dir == 'asc' %}
                            <i class="fas fa-caret-up"></i>
                        {% elif sort_by == 'year_month__yyyy' and sort_dir == 'desc' %}
                            <i class="fas fa-caret-down"></i>
                        {% endif %}
                    </a>
                </th>
                {% endcomment %}

                <th>
                    <a class="blue-text" href="?{{ mm_sort_anchor_GET_param }}">
                        Month
                        {% if sort_by == 'year_month__mm' and sort_dir == 'asc' %}
                            <i class="fas fa-caret-up"></i>
                        {% elif sort_by == 'year_month__mm' and sort_dir == 'desc' %}
                            <i class="fas fa-caret-down"></i>
                        {% endif %}
                    </a>
                </th>
                <th>Indicator Value</th>
                <th>Updated Date</th>
                <th>Last Updated By</th>
                <th>Category</th>
            </tr>
        </thead>
        <tbody>
            {% for entry in indicator_data_entries %}
            <tr>
                <td data-id="{{ entry.record_id }}" data-table="IndicatorData" data-column="Indicator">{{ entry.indicator }}</td>
                <td data-id="{{ entry.record_id }}" data-table="Year_Month" data-column="Fiscal_YYYY">{{ entry.year_month.fiscal_yyyy }}</td>
                {% comment %}
                <td data-id="{{ entry.record_id }}" data-table="Year_Month" data-column="YYYY">{{ entry.year_month.yyyy }}</td>
                {% endcomment %}
                <td data-id="{{ entry.record_id }}" data-table="Year_Month" data-column="MM">
                    {% if entry.year_month.mm == 1 %}
                    Jan
                    {% elif entry.year_month.mm == 2 %}
                    Feb
                    {% elif entry.year_month.mm == 3 %}
                    Mar
                    {% elif entry.year_month.mm == 4 %}
                    Apr
                    {% elif entry.year_month.mm == 5 %}
                    May
                    {% elif entry.year_month.mm == 6 %}
                    Jun
                    {% elif entry.year_month.mm == 7 %}
                    Jul
                    {% elif entry.year_month.mm == 8 %}
                    Aug
                    {% elif entry.year_month.mm == 9 %}
                    Sep
                    {% elif entry.year_month.mm == 10 %}
                    Oct
                    {% elif entry.year_month.mm == 11 %}
                    Nov
                    {% elif entry.year_month.mm == 12 %}
                    Dec
                    {% else %}
                    Unrecognized Month
                    {% endif %}
                </td>
                <td class="editable light-blue" data-id="{{ entry.record_id }}" data-table="IndicatorData" data-column="val">{{ entry.val }}</td>
                <td data-id="{{ entry.record_id }}" data-table="IndicatorData" data-column="UpdatedDate">{{ entry.updated_date }}</td>
                <td data-id="{{ entry.record_id }}" data-table="IndicatorData" data-column="UpdateUser">{{ entry.update_user }}</td>
                <td data-id="{{ entry.record_id }}" data-table="Category" data-column="Category_Name">{{ entry.indicator.category.category_name }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <!-- Paginations-->
    {% if is_paginated %}
        {% if page_obj.has_previous %}
            <a class="btn btn-outline-info" href="?page=1&{{ ctx_pagination_param }}">First</a>
            <a class="btn btn-outline-info" href="?page={{ page_obj.previous_page_number }}&{{ ctx_pagination_param }}">Previous</a>
        {% endif %}

        {%for num in page_obj.paginator.page_range %}
            {% if page_obj.number == num %}
                <a class=" btn btn-info" href="?page= {{ num }}&{{ ctx_pagination_param }}">{{ num }}</a>
            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                <a class=" btn btn-outline-info" href="?page= {{ num }}&{{ ctx_pagination_param }}">{{ num }}</a>
            {% endif %}
        {% endfor %}

        {% if page_obj.has_next %}
            <a class="btn btn-outline-info" href="?page={{ page_obj.next_page_number }}&{{ ctx_pagination_param }}">Next</a>
            <a class="btn btn-outline-info" href="?page= {{ page_obj.paginator.num_pages}}&{{ ctx_pagination_param }}">Last</a>
        {% endif %}
    {% endif %}
    <!--end pagination-->
</div>
<!--End WebGrid-->
{% endblock content %}

{% block custom_js %}
<script>
    $(document).ready(function () {
        $(document).on("dblclick", ".editable", function () {
            enterCellEditMode($(this))
        });

        $(document).on("keyup", ".input-data", function (e) {
            var key = e.which;
            if (key === 13) { // 13 is the return key, aka 'ENTER' key
                sendToServer(this);
            }
            if (key === 27) { // 27 is the ESC key
                cancelEditMode(this);
            }
        });

        $(document).ajaxStart(function () {
            $("body").addClass("loading");
        })
            .ajaxStop(function () {
                $("body").removeClass("loading");
            });

        function setDatabaseStatus(good, msg) {
            // Set status light and error message to red and response error msg
            if (good == true) {
                $('.status_info.led_light').html("Database Status: <div class='led_green'></div>");
                $('.status_info.err_msg').html("");
            } else {
                $('.status_info.led_light').html("Database Status: <div class='led_red'></div>");
                $('.status_info.err_msg').html("Error: " + msg);
            }
        }

        function finishCellEditMode(td_node) {
            td_node.addClass("editable");
        }

        function enterCellEditMode(td_node) {
            var old_value = td_node.text();
            var input = "<input type='text' class='input-data' value='" + old_value + "' class='form-control'>";
            td_node.html(input);
            td_node.removeClass("editable");
        }

        function cancelEditMode(node) {
            var old_val = $(node).attr("value")
            var td_node = $(node).parent("td");
            td_node.html(old_val);
            finishCellEditMode(td_node);
        }

        function csrfSafeMethod(method) {
            // these HTTP methods do not require CSRF protection
            return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
        }

        function sendToServer(node) {
            // console.log(id, new_value, table, column, td_node, old_val);
            var old_val = $(node).attr("value")
            var new_value = $(node).val();
            var td_node = $(node).parent("td");
            $(node).remove();

            id = td_node.data("id")
            table = td_node.data("table")
            column = td_node.data("column")

            $.ajaxSetup({
                beforeSend: function (xhr, settings) {
                    if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                        // Only send the token to relative URLs i.e. locally.
                        xhr.setRequestHeader("X-CSRFToken", Cookies.get('csrftoken'));
                    }
                }
            });

            $.ajax({
                url: "/PerInd/save_perind_data_api",
                type: "POST",
                data: {
                    id: id,
                    new_value: new_value,
                    table: table,
                    column: column,
                },
            })
            .done(function (json_response) {
                console.log("JSON RESPONSE", json_response);
                if (json_response["post_success"] == false) {
                    td_node.html(old_val);
                    console.log(`Error: Ajax calling SavePerIndDataApi: Server Response: ${json_response["post_msg"]}`);
                    alert(`Something went wrong trying to update Indicator Value.\nPlease contact ykuang@dot.nyc.gov if this error continues:\n\nAjax calling SavePerIndDataApi: Server Response: ${json_response["post_msg"]}`);

                    // Set status light and error message to red and response error msg
                    setDatabaseStatus(good = false, msg = json_response["post_msg"]);
                } else { // Api call successful
                    td_node.html(new_value);
                    $('[data-id="' + td_node.data('id') + '"][data-table="IndicatorData"][data-column="UpdatedDate"]').text(json_response["updated_timestamp"]);
                    $('[data-id="' + td_node.data('id') + '"][data-table="IndicatorData"][data-column="UpdateUser"]').text(json_response["updated_by"]);
                    setDatabaseStatus(good = true, msg = "");
                }
                finishCellEditMode(td_node);

                return true;
            }) // @TODO FOR TOMORROW< FIX THIS, when you turn off server, but still edit webgrid, make sure somehow the response is like server offline or not found!
            .fail(function (jqXHR) {
                td_node.html(old_val);
                // for (var x in jqXHR) {
                //     console.log(`Property check-> ${x}: ${jqXHR[x]}`)
                // }
                // var errorMessage = jqXHR.status + ': ' + jqXHR.responseXML
                var errorMessage = "Server might be down, try to reload the web page to confirm. Otherwise, try again and if error is still happening, contact ykuang@dot.nyc.gov"
                setDatabaseStatus(good = false, msg = errorMessage);
                finishCellEditMode(td_node);

                console.log(`Ajax Post: Error Occured: ${errorMessage}`);
                alert(`Ajax Post: Error Occured:\n\n${errorMessage}`);
                return false;
            });
        };
    })
</script>
{% endblock %}