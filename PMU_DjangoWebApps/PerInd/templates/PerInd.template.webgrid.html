{% extends 'template.base.html' %}
<!-- Will contain the template for the WebGrid html -->
{% block content %}

<div>Permission: {% for each in category_permissions %}{{each}}, {% endfor %}</div>
<div class="status_info led_light">Database Status: {% if req_success %}<div class='led_green'></div>{% else %}<div class='led_red'></div>{% endif %}</div>
<div class="status_info err_msg">{% if not req_success %} Error: '{{ err_msg }}'<br>Please try reloading the page again!<br>Please contact ykuang@dot.nyc.gov with a screenshot if this error continues. {% else %}{% endif %}</div>

<div class="table">
    <table class="table">
        <thead>
            <tr>
                <th>City wide value</th>
                <th>Indicator Title</th>
                <th>Year</th>
                <th>Month</th>
                <th>Updated date</th>
                <th>Last updated by</th>
                <th>Category</th>
            </tr>
        </thead>
        <tbody>
            {% for entry in indicator_data_entries %}
            <tr>
                <td class="editable" data-id="{{ entry.record_id }}" data-table="IndicatorData" data-column="val">{{ entry.val }}</td>
                <td data-id="{{ entry.record_id }}" data-table="IndicatorData" data-column="Indicator">{{ entry.indicator }}</td>
                <td data-id="{{ entry.record_id }}" data-table="Year_Month" data-column="YYYY">{{ entry.year_month.yyyy }}</td>
                <td data-id="{{ entry.record_id }}" data-table="Year_Month" data-column="MM">{{ entry.year_month.mm }}</td>
                <td data-id="{{ entry.record_id }}" data-table="IndicatorData" data-column="UpdatedDate">{{ entry.updated_date }}</td>
                <td data-id="{{ entry.record_id }}" data-table="IndicatorData" data-column="UpdateUser">{{ entry.update_user }}</td>
                <td data-id="{{ entry.record_id }}" data-table="Category" data-column="Category_Name">{{ entry.indicator.category.category_name }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <!-- Paginations-->
    {% if is_paginated %}
    {% if page_obj.has_previous %}

    <a class="btn btn-outline-info" href="?page=1">First</a>
    <a class="btn btn-outline-info" href="?page={{ page_obj.previous_page_number }}">Previous</a>
    {% endif %}

    {%for num in page_obj.paginator.page_range %}
    {% if page_obj.number == num %}
    <a class=" btn btn-info" href="?page= {{ num }}">{{ num }}</a>
    {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
    <a class=" btn btn-outline-info" href="?page= {{ num }}">{{ num }}</a>
    {% endif %}
    {% endfor %}

    {% if page_obj.has_next %}

    <a class="btn btn-outline-info" href="?page={{ page_obj.next_page_number }}">Next</a>
    <a class="btn btn-outline-info" href="?page= {{ page_obj.paginator.num_pages}}">Last</a>

    {% endif %}

    {% endif %}
    <!--end pagination-->
</div>
{% endblock content %}

{% block custom_js %}
<script>
    $(document).ready(function(){
        $(document).on("dblclick", ".editable", function(){
            enterCellEditMode($(this))
        });

        // $(document).on("blur", ".input-data", function(){
        //     var value = $(this).val();
        //     var td = $(this).parent("td");
        //     $(this).remove();
        //     td.html(value);
        //     td.addClass("editable");
        // });

        // @TODO: I need a way to cancel
        // @TODO: Change the enter key to a button yes or cancel
        $(document).on("keypress", ".input-data", function(e){
            var key = e.which;
            if(key==13){ // 13 is the return key, aka 'ENTER' key
                // HEHEHEHEHEHEHE, need to move this chucnk of code to ajax call back, or amek ajax block 
                // @TODO move this to Ajax call anyway, even though Ajax blocks with the loading icon right now, so why not? Send $(this) to sendToServer() as an arguement
                var old_val = $(this).attr("value")
                var new_value = $(this).val();
                var td = $(this).parent("td");
                $(this).remove();
                sendToServer( td.data("id"), new_value, td.data("table"), td.data("column"), td, old_val );
            }
        });

        $(document).ajaxStart(function() {
            $("body").addClass("loading");
        })
        .ajaxStop(function() {
            $("body").removeClass("loading");
        });

        
        // @TODO:(MOVING THIS TO THE BACKEND VIEW) Make sure CityWideValue can be converted to a float before sending Ajax call, else output error message, and reset old value

        function setDatabaseStatus(good, msg) {
            // Set status light and error message to red and response error msg
            if ( good == true ) {
                $('.status_info.led_light').html("Database Status: <div class='led_green'></div>");
                $('.status_info.err_msg').html("");
            } else {
                $('.status_info.led_light').html("Database Status: <div class='led_red'></div>");
                $('.status_info.err_msg').html("Error: " + msg);
            }
        }

        function finishCellEditMode(td_node) {
            td_node.addClass("editable");
        }

        function enterCellEditMode(td_node) {
            var old_value = td_node.text();
            var input = "<input type='text' class='input-data' value='"+old_value+"' class='form-control'>";
            td_node.html(input);
            td_node.removeClass("editable");
        }

        function csrfSafeMethod(method) {
            // these HTTP methods do not require CSRF protection
            return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
        }

        function sendToServer(id, new_value, table, column, td_node, old_val){
            // console.log(id, new_value, table, column, td_node, old_val);

            $.ajaxSetup({
                beforeSend: function(xhr, settings) {
                    if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                        // Only send the token to relative URLs i.e. locally.
                        xhr.setRequestHeader("X-CSRFToken", Cookies.get('csrftoken'));
                    }
                }
            });

            $.ajax({
                url: "/PerInd/save_perind_data_api",
                type: "POST",
                data: {
                    id: id,
                    new_value: new_value,
                    table: table,
                    column: column,
                },
            })
            .done(function(json_response){
                console.log("JSON RESPONSE", json_response);
                if( json_response["post_success"] == false ) {
                    td_node.html(old_val);
                    console.log(`Error: Ajax calling SavePerIndDataApi: Server Response: ${json_response["post_msg"]}`);
                    alert(`Something went wrong trying to update City Wide Value.\nPlease contact ykuang@dot.nyc.gov with a screenshot if this error continues:\n\nAjax calling SavePerIndDataApi: Server Response: ${json_response["post_msg"]}`);

                    // Set status light and error message to red and response error msg
                    setDatabaseStatus(good=false, msg=json_response["post_msg"]);
                } else { // Api call successful
                    td_node.html(new_value);
                    $('[data-id="' + td_node.data('id') + '"][data-table="IndicatorData"][data-column="UpdatedDate"]').text(json_response["updated_timestamp"]);
                    $('[data-id="' + td_node.data('id') + '"][data-table="IndicatorData"][data-column="UpdateUser"]').text(json_response["updated_by"]);
                    setDatabaseStatus(good=true, msg="");
                }
                finishCellEditMode(td_node);

                return true;
            }) // @TODO FOR TOMORROW< FIX THIS, when you turn off server, but still edit webgrid, make sure somehow the response is like server offline or not found!
            .fail(function(jqXHR){
                td_node.html(old_val);
                for (var x in jqXHR) {
                    console.log(`Property check-> ${x}: ${jqXHR[x]}`)
                }
                var errorMessage = jqXHR.status + ': ' + jqXHR.responseXML
                setDatabaseStatus(good=false, msg=errorMessage);
                finishCellEditMode(td_node);
                
                console.log("Ajax Post: Error Occured.");
                alert("Ajax Post: Error Occured.");
                return false;
            });
        };
    })
</script>
{% endblock %}