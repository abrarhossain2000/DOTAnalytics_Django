{% extends 'template.base.html' %}
<!-- Will contain the template for the WebGrid html -->
{% block content %}

<div>Permission: {% for each in category_permissions %}{{each}}, {% endfor %}</div>
<div class="status_info led_light">Database Status: {% if req_success %}<div class='led_green'></div>{% else %}<div class='led_red'></div>{% endif %}</div>
<div class="status_info err_msg">{% if not req_success %} Error: '{{ err_msg }}'<br>Please try reloading the page again!<br>If this continues, find out who to contact in the Contact Page. {% else %}{% endif %}</div>

<div class="table">
    <table class="table">
        <thead>
            <tr>
                <th>City wide value</th>

                <th><a href="?order=indicator{% if dir == 'descInd' %} ?dir=ascInd {% else %}?dir=descInd {% endif %}" name="sortClick" data-value="indicator" value="indicator" onclick="return call_sort(indicator,dir)">
    Indicator Title
    <!---<form action="actionURL" method="GET"><button type="submit">sort</button></form></th>-->

<th><a href="?order=year_month">Year</a></th>
                <th><a href="?order=year_month?dir=descMn">Month</a></th>
                <th>Updated date</th>
                <th>Last updated by</th>
                <th>Category</th>
            </tr>
        </thead>
        <tbody>
            {% for entry in indicator_data_entries %}
            <tr>
                <td class="editable" data-id="{{ entry.record_id }}" data-table="IndicatorData" data-column="val">{{ entry.val }}</td>
                <td data-id="{{ entry.record_id }}" data-table="IndicatorData" data-column="Indicator">{{ entry.indicator }}</td>
                <td data-id="{{ entry.record_id }}" data-table="Year_Month" data-column="YYYY">{{ entry.year_month.yyyy }}</td>
                <td data-id="{{ entry.record_id }}" data-table="Year_Month" data-column="MM">{{ entry.year_month.mm }}</td>
                <td data-id="{{ entry.record_id }}" data-table="IndicatorData" data-column="UpdatedDate">{{ entry.updated_date }}</td>
                <td data-id="{{ entry.record_id }}" data-table="IndicatorData" data-column="UpdateUser">{{ entry.update_user }}</td>
                <td data-id="{{ entry.record_id }}" data-table="Category" data-column="Category_Name">{{ entry.indicator.category.category_name }}</td>
            </tr>
            {% endfor %}
        </tbody>


    </table>
</div>

{% endblock content %}

{% block custom_js %}
<script>
    //new script for sorting
    function call_sort(data, order) {
        if (order == "descInd") {
            switch (data) {
                case "Indicator Title":

                    //data = data.OrderByDescending(i => i.Indicator_List.New_Indicator_Title);
                   
                    //pass column name and direction to views function 'sort_data'
                    data = "Indicator_Title"
                    dir="decInd"

                    $.ajax({
                        data: "Indicator_Title",
                        order: "descInd",
                        //success: function (data) { $('#target').html(data) }
                    });
                    break;
                case "YYYY":
                    // data = data.OrderByDescending(i => i.Year_Month.YYYY);
                    break;
                case "MM":
                    //data = data.OrderByDescending(i => i.Year_Month.MM);
                    break;
                default:
                    // data = data.OrderByDescending(i => i.Indicator_List.New_Indicator_Title);
                    break;
            }
        }
        // Defaults to ASC
        else {
            switch (data) {
                case "Indicator Title":
                    //data = data.OrderBy(i => i.Indicator_List.New_Indicator_Title);
                    break;
                case "YYYY":
                    // data = data.OrderBy(i => i.Year_Month.YYYY);
                    break;
                case "MM":
                    // data = data.OrderBy(i => i.Year_Month.MM);
                    break;
                default:
                    // data = data.OrderBy(i => i.Indicator_List.New_Indicator_Title);
                    break;
            }
        }

        return data;
    }

</script>

<script>
    $(document).ready(function () {
        $(document).on("dblclick", ".editable", function () {
            // var old_value = $(this).text();
            // var input = "<input type='text' class='input-data' value='"+old_value+"' class='form-control'>";
            // $(this).html(input);
            // $(this).removeClass("editable");
            enterCellEditMode($(this))
        });

        // $(document).on("blur", ".input-data", function(){
        //     var value = $(this).val();
        //     var td = $(this).parent("td");
        //     $(this).remove();
        //     td.html(value);
        //     td.addClass("editable");
        // });

        // @TODO: I need a way to cancel
        // @TODO: Change the enter key to a button yes or cancel
        $(document).on("keypress", ".input-data", function (e) {
            var key = e.which;
            // console.log(key)
            if (key == 13) { // 13 is the return key, aka 'ENTER' key
                // HEHEHEHEHEHEHE, need to move this chucnk of code to ajax call back, or amek ajax block
                var old_val = $(this).attr("value")
                var new_value = $(this).val();
                var td = $(this).parent("td");
                $(this).remove();
                sendToServer(td.data("id"), new_value, td.data("table"), td.data("column"), td, old_val);
            }
        });

        $(document).ajaxStart(function () {
            // @TODO Set loading modal
            $("body").addClass("loading");
        })
            .ajaxStop(function () {
                // @TODO Remove loading modal
                $("body").removeClass("loading");
            });


        // @TODO:(MOVING THIS TO THE BACKEND VIEW) Make sure CityWideValue can be converted to a float before sending Ajax call, else output error message, and reset old value

        function setDatabaseStatus(good, msg) {
            // Set status light and error message to red and response error msg
            if (good == true) {
                $('.status_info.led_light').html("Database Status: <div class='led_green'></div>");
                $('.status_info.err_msg').html("");
            } else {
                $('.status_info.led_light').html("Database Status: <div class='led_red'></div>");
                $('.status_info.err_msg').html("Error: " + msg);
            }
        }

        function finishCellEditMode(td_node) {
            td_node.addClass("editable");
        }

        function enterCellEditMode(td_node) {
            var old_value = td_node.text();
            var input = "<input type='text' class='input-data' value='" + old_value + "' class='form-control'>";
            td_node.html(input);
            td_node.removeClass("editable");
        }

        function csrfSafeMethod(method) {
            // these HTTP methods do not require CSRF protection
            return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
        }

        function sendToServer(id, new_value, table, column, td_node, old_val) {
            // console.log(id, new_value, table, column, td_node, old_val);

            $.ajaxSetup({
                beforeSend: function (xhr, settings) {
                    if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                        // Only send the token to relative URLs i.e. locally.
                        xhr.setRequestHeader("X-CSRFToken", Cookies.get('csrftoken'));
                    }
                }
            });

            $.ajax({
                url: "/PerInd/save_perind_data_api",
                type: "POST",
                data: {
                    id: id,
                    new_value: new_value,
                    table: table,
                    column: column,
                },
            })
                .done(function (json_response) {
                    console.log("JSON RESPONSE", json_response);
                    if (json_response["post_success"] == false) {
                        td_node.html(old_val);
                        console.log(`Error: Ajax calling SavePerIndDataApi: Server Response: ${json_response["post_msg"]}`);
                        alert(`Something went wrong trying to update City Wide Value.\nPlease contact ykuang@dot.nyc.gov if this error continues:\n\nAjax calling SavePerIndDataApi: Server Response: ${json_response["post_msg"]}`);

                        // Set status light and error message to red and response error msg
                        setDatabaseStatus(good = false, msg = json_response["post_msg"]);
                    } else { // Api call successful
                        td_node.html(new_value);
                        $('[data-id="' + td_node.data('id') + '"][data-table="IndicatorData"][data-column="UpdatedDate"]').text(json_response["updated_timestamp"]);
                        $('[data-id="' + td_node.data('id') + '"][data-table="IndicatorData"][data-column="UpdateUser"]').text(json_response["updated_by"]);
                        setDatabaseStatus(good = true, msg = "");
                    }
                    finishCellEditMode(td_node);

                    return true;
                })
                .fail(function () {
                    td_node.html(old_val);
                    setDatabaseStatus(good = false, msg = "");
                    finishCellEditMode(td_node);

                    console.log("Ajax Post: Error Occured.");
                    alert("Ajax Post: Error Occured.");
                    return false;
                });
        };
    })
</script>
{% endblock %}