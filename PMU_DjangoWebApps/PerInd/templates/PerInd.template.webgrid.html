{% extends 'template.base.html' %}
<!-- Will contain the template for the WebGrid html -->
{% block content %}
<style>
    .dropdown,.content {
        margin: 2.5px;
       
    }

   
</style>
    <div class="container">
        <div>Permission: {% for each in category_permissions %}{{each}}, {% endfor %}</div>
        <div class="status_info led_light">Database Status: {% if req_success %}<div class='led_green'></div>{% else %}<div class='led_red'></div>{% endif %}</div>
        <div class="status_info err_msg">{% if not req_success %} Error: '{{ err_msg }}'<br>Please try reloading the page again!<br>Please contact ykuang@dot.nyc.gov with a screenshot if this error continues. {% else %}{% endif %}</div>
        <!--Dropdown-->
        <div class="container">
            <div class="dropdown">
                <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton1" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                     Title
                </button>
                <form>
                    <div class="dropdown-menu" aria-labelledby="dropdownMenuButton1">
                        {% for each in uniq_titles %}
                        <a data-unique_title="ind" class="dropdown-item"><input type="checkbox" name="title_list" value="{{ each.indicator__indicator_title }}"/> {{ each.indicator__indicator_title }}</a>
                        {% endfor %}
                        <button type="submit" class="btn btn-info">Filter</button>
                    </div>
                </form>
            </div>
            <div class="dropdown">
                <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton2" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    Year
                </button>
                <div class="dropdown-menu" aria-labelledby="dropdownMenuButton2">
                    {% for each in uniq_years %}
                    <a data-unique_title="ind" class="dropdown-item" href="#"><input type="checkbox" /> {{ each.year_month__yyyy}}</a>

                    {% endfor %}
                    <button type="button" class="btn btn-info">Filter</button>
                </div>
            </div>
            <div class="dropdown">
                <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton3" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    Month
                </button>
                <div class="dropdown-menu" aria-labelledby="dropdownMenuButton3">
                    {% for each in uniq_months %}

                    {% if each.year_month__mm == 1 %}
                    <a data-unique_title="ind" class="dropdown-item" href="#"><input type="checkbox" /> Jan</a>
                    {% elif each.year_month__mm == 2 %}
                    <a data-unique_title="ind" class="dropdown-item" href="#"><input type="checkbox" /> Feb</a>
                    {% elif each.year_month__mm == 3 %}
                    <a data-unique_title="ind" class="dropdown-item" href="#"><input type="checkbox" /> Mar</a>
                    {% elif each.year_month__mm == 4 %}
                    <a data-unique_title="ind" class="dropdown-item" href="#"><input type="checkbox" /> Apr</a>
                    {% elif each.year_month__mm == 5 %}
                    <a data-unique_title="ind" class="dropdown-item" href="#"><input type="checkbox" /> May</a>
                    {% elif each.year_month__mm == 6 %}
                    <a data-unique_title="ind" class="dropdown-item" href="#"><input type="checkbox" /> Jun</a>
                    {% elif each.year_month__mm == 7 %}
                    <a data-unique_title="ind" class="dropdown-item" href="#"><input type="checkbox" /> Jul</a>
                    {% elif each.year_month__mm == 8 %}
                    <a data-unique_title="ind" class="dropdown-item" href="#"><input type="checkbox" /> Aug</a>
                    {% elif each.year_month__mm == 9 %}
                    <a data-unique_title="ind" class="dropdown-item" href="#"><input type="checkbox" /> Sep</a>
                    {% elif each.year_month__mm == 10 %}
                    <a data-unique_title="ind" class="dropdown-item" href="#"><input type="checkbox" /> Oct</a>
                    {% elif each.year_month__mm == 11 %}
                    <a data-unique_title="ind" class="dropdown-item" href="#"><input type="checkbox" /> Nov</a>
                    {% elif each.year_month__mm == 12 %}
                    <a data-unique_title="ind" class="dropdown-item" href="#"><input type="checkbox" /> Dec</a>
                    {% else %}
                    Unrecognized Month
                    {% endif %}

                    {% endfor %}
                    <button type="button" class="btn btn-info">Filter</button>
                </div>
            </div>
        </div>
        <!--End Dropdown-->
        <div class="table">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>
                            <a href="?SortBy=indicator__indicator_title&{% if sort_by == 'indicator__indicator_title' and sort_dir == 'asc' %}SortDir=desc{% elif sort_by == 'indicator__indicator_title' and sort_dir == 'desc' %}SortDir=asc{% else %}SortDir=asc{% endif %}">
                                Indicator Title{% if sort_by == 'indicator__indicator_title' and sort_dir == 'asc' %} <i class="fas fa-caret-up"></i></i>{% elif sort_by == 'indicator__indicator_title' and sort_dir == 'desc' %} <i class="fas fa-caret-down"></i>{% endif %}
                            </a>
                        </th>
                     
                        <th>
           
                            <a href="?SortBy=year_month__yyyy&{% if sort_by == 'year_month__yyyy' and sort_dir == 'asc' %}SortDir=desc{% elif sort_by == 'year_month__yyyy' and sort_dir == 'desc' %}SortDir=asc{% else %}SortDir=asc{% endif %}">
                                Year{% if sort_by == 'year_month__yyyy' and sort_dir == 'asc' %} <i class="fas fa-caret-up"></i></i>{% elif sort_by == 'year_month__yyyy' and sort_dir == 'desc' %} <i class="fas fa-caret-down"></i>{% endif %}
                            </a>
                        </th>
                        <th>
                            <a href="?SortBy=year_month__mm&{% if sort_by == 'year_month__mm' and sort_dir == 'asc' %}SortDir=desc{% elif sort_by == 'year_month__mm' and sort_dir == 'desc' %}SortDir=asc{% else %}SortDir=asc{% endif %}">
                                Month{% if sort_by == 'year_month__mm' and sort_dir == 'asc' %} <i class="fas fa-caret-up"></i></i>{% elif sort_by == 'year_month__mm' and sort_dir == 'desc' %} <i class="fas fa-caret-down"></i>{% endif %}
                            </a>
                        </th>
                        <th>Indicator Value</th>
                        <th>Updated Date</th>
                        <th>Last Updated By</th>
                        <th>Category</th>
                    </tr>
                </thead>
                <tbody>
                    {% for entry in indicator_data_entries %}
                    <tr>
                        <td data-id="{{ entry.record_id }}" data-table="IndicatorData" data-column="Indicator">{{ entry.indicator }}</td>
                        <td data-id="{{ entry.record_id }}" data-table="Year_Month" data-column="YYYY">{{ entry.year_month.yyyy }}</td>
                        <!-- <td data-id="{{ entry.record_id }}" data-table="Year_Month" data-column="MM">{{ entry.year_month.mm }}</td> -->
                        <td data-id="{{ entry.record_id }}" data-table="Year_Month" data-column="MM">
                            {% if entry.year_month.mm == 1 %}
                            Jan
                            {% elif entry.year_month.mm == 2 %}
                            Feb
                            {% elif entry.year_month.mm == 3 %}
                            Mar
                            {% elif entry.year_month.mm == 4 %}
                            Apr
                            {% elif entry.year_month.mm == 5 %}
                            May
                            {% elif entry.year_month.mm == 6 %}
                            Jun
                            {% elif entry.year_month.mm == 7 %}
                            Jul
                            {% elif entry.year_month.mm == 8 %}
                            Aug
                            {% elif entry.year_month.mm == 9 %}
                            Sep
                            {% elif entry.year_month.mm == 10 %}
                            Oct
                            {% elif entry.year_month.mm == 11 %}
                            Nov
                            {% elif entry.year_month.mm == 12 %}
                            Dec
                            {% else %}
                            Unrecognized Month
                            {% endif %}
                        </td>
                        <td class="editable" data-id="{{ entry.record_id }}" data-table="IndicatorData" data-column="val">{{ entry.val }}</td>
                        <td data-id="{{ entry.record_id }}" data-table="IndicatorData" data-column="UpdatedDate">{{ entry.updated_date }}</td>
                        <td data-id="{{ entry.record_id }}" data-table="IndicatorData" data-column="UpdateUser">{{ entry.update_user }}</td>
                        <td data-id="{{ entry.record_id }}" data-table="Category" data-column="Category_Name">{{ entry.indicator.category.category_name }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <!-- Paginations-->
            <!-- @TODO need to add template url for this entire page to link with. -->
            {% if is_paginated %}
            {% if page_obj.has_previous %}

            <a class="btn btn-outline-info" href="?page=1&SortBy={{ sort_by }}&SortDir={{ sort_dir }}&title_list= {{ title_list }}">First</a>
            <a class="btn btn-outline-info" href="?page={{ page_obj.previous_page_number }}&SortBy={{ sort_by }}&SortDir={{ sort_dir }}&title_list= {{ title_list }}">Previous</a>
            {% endif %}

            {%for num in page_obj.paginator.page_range %}
            {% if page_obj.number == num %}
            <a class=" btn btn-info" href="?page= {{ num }}&SortBy={{ sort_by }}&SortDir={{ sort_dir }}&title_list= {{ title_list }}">{{ num }}</a>
            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
            <a class=" btn btn-outline-info" href="?page= {{ num }}&SortBy={{ sort_by }}&SortDir={{ sort_dir }}&title_list= {{ title_list }}">{{ num }}</a>
            {% endif %}
            {% endfor %}

            {% if page_obj.has_next %}

            <a class="btn btn-outline-info" href="?page={{ page_obj.next_page_number }}&SortBy={{ sort_by }}&SortDir={{ sort_dir }}&title_list= {{ title_list }}">Next</a>
            <a class="btn btn-outline-info" href="?page= {{ page_obj.paginator.num_pages}}&SortBy={{ sort_by }}&SortDir={{ sort_dir }}&title_list= {{ title_list }}">Last</a>

            {% endif %}

            {% endif %}
            <!--end pagination-->
        </div>
    </div>
{% endblock content %}

{% block custom_js %}


<script>
    $(document).ready(function(){
        $(document).on("dblclick", ".editable", function(){
            enterCellEditMode($(this))
        });

        // $(document).on("blur", ".input-data", function(){
        //     var value = $(this).val();
        //     var td = $(this).parent("td");
        //     $(this).remove();
        //     td.html(value);
        //     td.addClass("editable");
        // });

        // @TODO: I need a way to cancel
        // @TODO: Change the enter key to a button yes or cancel
        $(document).on("keypress", ".input-data", function (e) {
            var key = e.which;
            if(key==13){ // 13 is the return key, aka 'ENTER' key
                sendToServer(this);
            }
        });

        $(document).ajaxStart(function() {
            $("body").addClass("loading");
        })
        .ajaxStop(function() {
            $("body").removeClass("loading");
        });

        function setDatabaseStatus(good, msg) {
            // Set status light and error message to red and response error msg
            if (good == true) {
                $('.status_info.led_light').html("Database Status: <div class='led_green'></div>");
                $('.status_info.err_msg').html("");
            } else {
                $('.status_info.led_light').html("Database Status: <div class='led_red'></div>");
                $('.status_info.err_msg').html("Error: " + msg);
            }
        }

        function finishCellEditMode(td_node) {
            td_node.addClass("editable");
        }

        function enterCellEditMode(td_node) {
            var old_value = td_node.text();
            var input = "<input type='text' class='input-data' value='" + old_value + "' class='form-control'>";
            td_node.html(input);
            td_node.removeClass("editable");
        }

        function csrfSafeMethod(method) {
            // these HTTP methods do not require CSRF protection
            return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
        }

        function sendToServer(node){
            // console.log(id, new_value, table, column, td_node, old_val);
            var old_val = $(node).attr("value")
            var new_value = $(node).val();
            var td_node = $(node).parent("td");
            $(node).remove();

            id = td_node.data("id")
            table = td_node.data("table")
            column = td_node.data("column")

            $.ajaxSetup({
                beforeSend: function (xhr, settings) {
                    if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                        // Only send the token to relative URLs i.e. locally.
                        xhr.setRequestHeader("X-CSRFToken", Cookies.get('csrftoken'));
                    }
                }
            });

            $.ajax({
                url: "/PerInd/save_perind_data_api",
                type: "POST",
                data: {
                    id: id,
                    new_value: new_value,
                    table: table,
                    column: column,
                },
            })
            .done(function (json_response) {
                console.log("JSON RESPONSE", json_response);
                if (json_response["post_success"] == false) {
                    td_node.html(old_val);
                    console.log(`Error: Ajax calling SavePerIndDataApi: Server Response: ${json_response["post_msg"]}`);
                    alert(`Something went wrong trying to update Indicator Value.\nPlease contact ykuang@dot.nyc.gov if this error continues:\n\nAjax calling SavePerIndDataApi: Server Response: ${json_response["post_msg"]}`);

                    // Set status light and error message to red and response error msg
                    setDatabaseStatus(good = false, msg = json_response["post_msg"]);
                } else { // Api call successful
                    td_node.html(new_value);
                    $('[data-id="' + td_node.data('id') + '"][data-table="IndicatorData"][data-column="UpdatedDate"]').text(json_response["updated_timestamp"]);
                    $('[data-id="' + td_node.data('id') + '"][data-table="IndicatorData"][data-column="UpdateUser"]').text(json_response["updated_by"]);
                    setDatabaseStatus(good = true, msg = "");
                }
                finishCellEditMode(td_node);

                return true;
            }) // @TODO FOR TOMORROW< FIX THIS, when you turn off server, but still edit webgrid, make sure somehow the response is like server offline or not found!
            .fail(function(jqXHR){
                td_node.html(old_val);
                // for (var x in jqXHR) {
                //     console.log(`Property check-> ${x}: ${jqXHR[x]}`)
                // }
                // var errorMessage = jqXHR.status + ': ' + jqXHR.responseXML
                var errorMessage = "Server might be down, try to reload the web page to confirm. Otherwise, try again and if error is still happening, contact ykuang@dot.nyc.gov"
                setDatabaseStatus(good=false, msg=errorMessage);
                finishCellEditMode(td_node);
                
                console.log(`Ajax Post: Error Occured: ${errorMessage}`);
                alert(`Ajax Post: Error Occured:\n\n${errorMessage}`);
                return false;
            });
        };
    })
</script>
{% endblock %}