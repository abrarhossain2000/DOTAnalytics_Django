{% extends 'MapsApp.template.base.html' %}

{% load static %}



{% block content %}
<div>Leaflet.js</div>
<div>NYC Borough</div>
<select id="filter"></select>
<div>Select DOT Service</div>
<select id="service_filter"></select>
<div>Social Backdrop</div>
<select id="social_filter"></select>
<div id='map_container'></div>

{% endblock %}







{% block custom_js %}
{% comment %} <script type="text/javascript" src={% static 'MapsApp/js/d3.v6.min.js' %}></script> {% endcomment %}
{% comment %} <script type="text/javascript" src={% static 'MapsApp/js/map1_d3.js' %}></script> {% endcomment %}
    <link
        rel="stylesheet"
        href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css"
    />
    <script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js"></script>

    <script src="https://d3js.org/d3-fetch.v2.min.js"></script>
    <style>
        #map_container {
            height: 600px;
            width: 600px;
        }
    </style>

    <script>
        $( document ).ready(async function(){
            // Initialize Leaflet, and set a long & lat as the center of the view (Long/Lat is abritrary, anywhere in the city that you deem good will do)
            var map = L.map("map_container").setView([40.703312, -73.97968], 10);

            // L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { // Load in the open street map as the base layer
            L.tileLayer('https://maps{s}.nyc.gov/xyz/1.0.0/carto/basemap/{z}/{x}/{y}.jpg', {
                minNativeZoom: 8,
                maxNativeZoom: 19,
                subdomains: '1234',
                bounds: L.latLngBounds([39.3682, -75.9374], [42.0329, -71.7187]),
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            }).addTo(map);

            var layer_dict = {};
            // Load in the nyc geojson
            d3.json('/static/MapsApp/geojsons/nyc.geojson')
            .then(function(data) {
                let nycBoroLayer = L.geoJson(data, {
                    style: {
                        color: "#ff00000",
                        strokeColor: "red"
                    }
                }).addTo(map);

                // Creating the list for the dropdown
                const filterInput = document.getElementById('filter')
                const options = data.features.map(function(feature){
                    return `<option value='${feature.properties.boro_name}'>${feature.properties.boro_name}</option>`
                }).join('')
                filterInput.innerHTML = '<option>All</option>' + options

                // Filter with selected value in the <select></select>
                filterInput.addEventListener('change', function(){
                    const value = filterInput.value

                    // Remove boro layer, and we will recreate the boro layer and add it back to the map
                    map.removeLayer(nycBoroLayer)

                    if(value === 'All'){
                        nycBoroLayer = L.geoJson(data, {
                            style: {
                                color: "#ff00000",
                                strokeColor: "red",
                                weight:1
                        }
                        }).addTo(map)
                    }else{
                        let newData = {
                            "type": "FeatureCollection",
                            "features": data.features.filter(function(feature){ // Filtering happens here
                                return feature.properties.boro_name === value
                            })
                        }

                        // Re-add the boro layer (Now filtered down)
                        nycBoroLayer = L.geoJson(newData, {
                            style: {
                                color: "#ff00000",
                                strokeColor: "red",
                                weight:1
                        }
                        }).addTo(map)
                    }
                })
                return nycBoroLayer;
            })
            .then( function(layer) {
                layer_dict['nycBoroLayer'] = layer;
            });

            // Load in the vision zero geojson
            d3.json('/static/MapsApp/geojsons/vzv_bike_priority_districts_reprojected_4326.geojson')
            .then(function(data1) {
                let layer = L.geoJson(data1, {
                    // Create a pop up text when you click on each element/feature
                    onEachFeature: function(feature, layer){
                            layer.bindPopup(feature.properties.BoroCD_code) // Access the geoJson['feature']['properties']['BoroCD_code'], take a look at static/MapsApp/geojsons/vzv_bike_priority_districts_reprojected_4326.geojson to see how the json file is formated, and you will understand this part
                        }
                }).addTo(map);
                return layer;
            })
            .then(function(layer) {
                layer_dict['vzvLayer'] = layer;
            });

            // Load in the NTA geojson
            //source: https://stackoverflow.com/questions/38733012/leaflet-js-choropleth-example-updating-color-based-on-separate-data-file
            //first idea: create an array with each code and medium income and then shade it based on that.
            //issues: will this data be updated? this might take time to calculate the medium for all NTA's
            var pov_array = [{
                'code': 'BK83',
                'income': 46012
            },];
            function getColor(income) {
                if (income > 5) return 'yellow';
                return 'red';
            }
            function getNTAColor(ntacode) {
                var color;
                for (var i = 0; i < pov_array.length; i++) {
                    if (pov_array[i].code === ntacode) {
                        color = getColor(pov_array[i].income);
                        //console.log("color",color);
                        break;
                    }
                }
                return color;
            }
            d3.json('/static/MapsApp/geojsons/NTA.geojson')
            .then(function (data2) {
                let layer = L.geoJson(data2, {
                    // Create a pop up text when you click on each element/feature
                    style: function (feature, layer) {
                        return {
                            fillColor: getNTAColor(feature.properties.ntacode),
                            color: 'white',
                            weight:1
                            //layer.bindPopup(feature.properties.BoroCD_code)
                        }
                    }
                }).addTo(map);

                return layer;
            })
            .then(function(layer) {
                layer_dict['ntaLayer'] = layer;
            });


            // Toggle between NTA and VZV Bike Layer
            const layerFilterInput = document.getElementById('service_filter')
            const options = [ 'VZV Bike Stuff'].map(function(each){ // Create the drop down list
                return `<option value='${each}'>${each}</option>`
            }).join('')
            layerFilterInput.innerHTML = '<option>All</option>' + options

            const layerFilterSocialInput = document.getElementById('social_filter')
            const options2 = ['NTA Stuff'].map(function (each) { // Create the drop down list
                return `<option value='${each}'>${each}</option>`
            }).join('')
            layerFilterSocialInput.innerHTML = '<option>All</option>' + options2


            // Filter with selected value in the <select></select>
            layerFilterInput.addEventListener('change', function(){
                const value = layerFilterInput.value

                // Remove all layer from map, and we will re-add the layers to the map base on the filter selection
                // Iterate through the layer_dict with access to its key and element
                Object.keys(layer_dict).map(function(key, index) {
                    // console.log(key, index);
                    // console.log(layer_dict[key]);
                    map.removeLayer(layer_dict[key])
                });

                if(value === 'All'){
                    Object.keys(layer_dict).map(function(key, index) {
                        layer_dict[key].addTo(map)
                    });
                }
                //else if (value === 'NYC Boro Stuff') {
                  //  layer_dict['nycBoroLayer'].addTo(map)
            //} 
                else if (value === 'VZV Bike Stuff') {
                    layer_dict['vzvLayer'].addTo(map)
                } else if (value === 'NTA Stuff') {
                    layer_dict['ntaLayer'].addTo(map)
                } else {
                    console.log('layer not valid to add to map')
                }
            })

       
            layerFilterSocialInput.addEventListener('change', function () {
                const value = layerFilterSocialInput.value

                // Remove all layer from map, and we will re-add the layers to the map base on the filter selection
                // Iterate through the layer_dict with access to its key and element
                Object.keys(layer_dict).map(function (key, index) {
                    // console.log(key, index);
                    // console.log(layer_dict[key]);
                    map.removeLayer(layer_dict[key])
                });

                if (value === 'All') {
                    Object.keys(layer_dict).map(function (key, index) {
                        layer_dict[key].addTo(map)
                    });
                }
                //else if (value === 'NYC Boro Stuff') {
                //  layer_dict['nycBoroLayer'].addTo(map)
                //}
                else if (value === 'VZV Bike Stuff') {
                    layer_dict['vzvLayer'].addTo(map)
                } else if (value === 'NTA Stuff') {
                    layer_dict['ntaLayer'].addTo(map)
                } else {
                    console.log('layer not valid to add to map')
                }
            });

        });

    </script>
{% endblock %}