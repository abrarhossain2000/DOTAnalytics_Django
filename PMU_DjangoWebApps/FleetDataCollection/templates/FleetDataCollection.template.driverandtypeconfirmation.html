{% extends 'FleetDataCollection.template.base.html' %}

{% load static %}

{% block custom_css %}
    <link rel="stylesheet" type="text/css" href="{% static 'PMU_DjangoWebApps/DataTables/datatables.css' %}" />
{% endblock %}

{% block content %}
    <div class="navbar navbar-expand-lg">
        <h2 class="mt-3">
            Driver Assignment and Type Assignment Confirmation
        </h2>
        <div class="status_info err_msg">{% if not req_success %} Error: '{{ err_msg }}'<br>Please try reloading the page again!<br>Please contact ykuang@dot.nyc.gov with a screenshot if this error continues. {% else %}{% endif %}</div>
    </div>

    <!--m5 vehicle driver and type assignment confirmation web grid-->
    <table class="table table-striped table-hover" id="WebGridTable">
        <thead>
            <tr>
                <th >Vehicle #</th>
                <th class="light-blue">PMS</th>
                <th class="light-blue">Assignment Type</th>
            </tr>
        </thead>

        <tbody>
            {% for entry in driver_type_assigment_entries %}
            <tr>
                <td data-id="{{ entry.unit_number }}" data-table="FleetDataCollectionM5DriverVehicleDataConfirmations" data-column="UnitNumber">{{ entry.unit_number }}</td>
                <td class="editable-select" data-id="{{ entry.unit_number }}" data-table="FleetDataCollectionM5DriverVehicleDataConfirmations" data-column="PMS">{{ entry.pms }}</td>
                <td class="editable-select" data-id="{{ entry.unit_number }}" data-table="FleetDataCollectionM5DriverVehicleDataConfirmations" data-column="Class2">{{ entry.class2 }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <!--End admin access control web grid-->
{% endblock content %}

{% block custom_js %}
    <script type="text/javascript" charset="utf8" src="{% static 'PMU_DjangoWebApps/DataTables/datatables.js' %}"></script>
    <script type="text/javascript" charset="utf8" src="{% static 'PMU_DjangoWebApps/js/CellEditSave.js' %}"></script>

    <script>
        $(document).ready( function () {
            $.ajaxSetup({
                beforeSend: function (xhr, settings) {
                    if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                        // Only send the token to relative URLs i.e. locally.
                        xhr.setRequestHeader("X-CSRFToken", Cookies.get('csrftoken'));
                    }
                }
            });

            var table = $('#WebGridTable').DataTable();
            var pms_list_str = [] // Use this only after the async ajax function call to get_permitted_pms_list returns
            var pms_list_additional_info_json = new Object(); // Use this only after the async ajax function call to get_permitted_pms_list returns

            // Get PMS List
            $.ajax({
                url: "/FleetDataCollection/get_permitted_pms_list",
                type: "POST",
            })
            .done(function(json_response) {
                if (json_response["post_success"] == false) {
                    console.log(`Error: Ajax calling GetPMSList: Server Response: ${json_response["post_msg"]}`);
                    alert(`Something went wrong while trying to get list of PMS.\nPlease contact ykuang@dot.nyc.gov if this error continues:\n\nAjax calling GetPMSList: Server Response: ${json_response["post_msg"]}`);
                } else { // Api call successful
                    list_of_json_pms_response = json_response["post_data"]
                    list_of_json_pms_response.map(function(each) {
                        pms_list_str.push(each.pms)
                        pms_list_additional_info_json[each.pms] = each.last_name + ', ' + each.first_name
                    })
                }
                return true;
            })
            .fail(function(json_response) {
                var errorMessage = `Server might be down, try to reload the web page to confirm. Otherwise, try again and if error is still happening, contact ykuang@dot.nyc.gov\n xhr response: ${jqXHR.status}\n xhr response text: ${jqXHR.responseText}`;
                console.log(`Ajax Post: Error Occured: ${errorMessage}`);
                alert(`Ajax Post: Error Occured:\n\n${errorMessage}`);
                return false;
            });

            // For cell select mode
            $(document).on("dblclick", ".editable-select", function () {
                if ( $(this).data('column') == 'PMS' ) {
                    select_list_values = ['None']
                    select_list_values = select_list_values.concat(pms_list_str)
                } else if ( $(this).data('column') == 'Class2' ) {
                    select_list_values = ['None', 'True', 'False']
                } else {
                    console.log(`'${$(this).data('column')}' column not supported for editable-select cells edit`)
                    alert(`'${$(this).data('column')}' column not supported for editable-select cells edit`)
                    return 0
                }

                // Move current select element to the top of the array
                var current_value = $(this).text()
                select_list_values.sort(function(x, y) {
                    return x == current_value ? -1 : y == current_value ? 1 : 0;
                });


                if ( $(this).data('column') == 'PMS' ) {
                    enterCellEditSelectMode($(this), select_list_values, true, pms_list_additional_info_json, "display additional first")
                } else if ( $(this).data('column') == 'Class2' ) {
                    enterCellEditSelectMode($(this), select_list_values)
                } else {
                    console.log(`'${$(this).data('column')}' column not supported for editable-select cells edit`)
                    alert(`'${$(this).data('column')}' column not supported for editable-select cells edit`)
                    return 0
                }
            });

            $(document).on("keyup", ".input-data-select", function (e) {
                var key = e.which;
                if (key === 27) { // 27 is the ESC key
                    cancelSelectMode(this);
                }
            });

            $(document).on("change", ".input-data-select", function () {
                if ( ($(this).parent().data('column') == 'PMS') || ($(this).parent().data('column') == 'Class2') ) {
                    sendCellToServer(this, "update_m5_driver_vehicle_data_confirmations", "select");
                } else {
                    console.log(`sendCellToServer() doesn't support '${$(this).parent().data('column')}' column for editable-select cells to sent api call`)
                    alert(`sendCellToServer() doesn't support '${$(this).parent().data('column')}' column for editable-select cells to sent api call`)
                    return 0
                }
            });

        });
    </script>
{% endblock custom_js %}