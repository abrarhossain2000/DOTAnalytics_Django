{% extends 'OrgChartPortal.template.base.html' %}

{% load static %}

{% block custom_css %}
    <link rel="stylesheet" type="text/css" href="{% static 'PMU_DjangoWebApps/DataTables/datatables.css' %}" />
{% endblock %}

{% block content %}
    <div class="navbar navbar-expand-lg">
        <h2 class="mt-3">
            Orgchart Portal
        </h2>
        <div class="status_info err_msg">{% if not req_success %} Error: '{{ err_msg }}'<br>Please try reloading the page again!<br>Please contact ykuang@dot.nyc.gov with a screenshot if this error continues. {% else %}{% endif %}</div>
    </div>


    <table class="table table-striped table-hover" id="JSDataTable">
        <thead>
            <tr>
                <th>WU</th>
                <th>L-Name</th>
                <th>F-Name</th>
                <th>PMS</th>
                <th>Title</th>
                <th>Supervisor Name</th>
                <th>Office Title</th>
                <th>Work Location</th>
                <th>Location Floor</th>
                <th>Site Type</th>
                <th>ABC Group</th>
            </tr>
        </thead>

        <body id="JSDataTableBody">
            {% for entry in emp_entries %}
            <tr>
                <td data-entrypms="{{ entry.pms }}" data-table="tblEmployees" data-column="WU">{{ entry.wu.wu }}</td>
                <td data-entrypms="{{ entry.pms }}" data-table="tblEmployees" data-column="L-Name">{{ entry.last_name }}</td>
                <td data-entrypms="{{ entry.pms }}" data-table="tblEmployees" data-column="F-Name">{{ entry.first_name }}</td>
                <td data-entrypms="{{ entry.pms }}" data-table="tblEmployees" data-column="PMS#">{{ entry.pms }}</td>
                <td data-entrypms="{{ entry.pms }}" data-table="tblEmployees" data-column="Title">{{ entry.title }}</td>
                <td data-entrypms="{{ entry.pms }}" data-table="tblEmployees" data-column="SupervisorPMS">
                    {% if entry.supervisor_pms.last_name and entry.supervisor_pms.first_name %}
                        {{ entry.supervisor_pms.last_name }}, {{ entry.supervisor_pms.first_name }}
                    {% else %}
                    {% endif %}
                </td>
                <td data-entrypms="{{ entry.pms }}" data-table="tblEmployees" data-column="OfficeTitle">{{ entry.office_title }}</td>
                <td data-entrypms="{{ entry.pms }}" data-table="tblEmployees" data-column="ActualSiteId">{{ entry.actual_site_id.site }}</td>
                <td data-entrypms="{{ entry.pms }}" data-table="tblEmployees" data-column="ActualFloorId">{{ entry.actual_floor_id.floor }}</td>
                <td data-entrypms="{{ entry.pms }}" data-table="tblEmployees" data-column="ActualSiteTypeId">{{ entry.actual_site_type_id.site_type }}</td>
                <td data-entrypms="{{ entry.pms }}" data-table="tblEmployees" data-column="ABCGroup">{{ entry.abc_group }}</td>
            </tr>
            {% endfor %}
        </body>
    </table>
{% endblock content %}

{% block custom_js %}
    <script type="text/javascript" charset="utf8" src="{% static 'PMU_DjangoWebApps/DataTables/datatables.js' %}"></script>
    <script type="text/javascript" charset="utf8" src="{% static 'PMU_DjangoWebApps/js/CellEditSave.js' %}"></script>

    <script>
        $(document).ready( function () {
            // Reset the default viewport from css class container to container-fluid
            $(".container").attr('class', 'container-fluid')

            $.ajaxSetup({
                beforeSend: function (xhr, settings) {
                    if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                        // Only send the token to relative URLs i.e. locally.
                        xhr.setRequestHeader("X-CSRFToken", Cookies.get('csrftoken'));
                    }
                }
            });

            var table = $('#JSDataTable').DataTable({
                dom: 'Bfstip',
                buttons: [
                    {
                        extend: 'csv',
                        text: 'Download as CSV',
                    }
                ]
            });

            {% comment %}
            // For cell select mode
            $(document).on("dblclick", ".editable-select", function () {
                if ( $(this).data('column') == 'PMS' ) {
                    select_list_values = ['None']
                    select_list_values = select_list_values.concat(select_permitted_pms_list)
                } else if ( $(this).data('column') == 'Class2' ) {
                    //select_list_values = ['None', 'Commuter', 'Non-Commuter']
                    select_list_values = ['Commuter', 'Non-Commuter']
                } else {
                    console.log(`'${$(this).data('column')}' column not supported for editable-select cells edit`)
                    alert(`'${$(this).data('column')}' column not supported for editable-select cells edit`)
                    return 0
                }

                // Move current select element to the top of the array
                var current_value = $(this).text()
                select_list_values.sort(function(x, y) {
                    return x == current_value ? -1 : y == current_value ? 1 : 0;
                });


                if ( $(this).data('column') == 'PMS' ) {
                    enterCellEditSelectMode($(this), select_list_values, true, select_permitted_pms_list_additional_info_json, "display additional first")
                } else if ( $(this).data('column') == 'Class2' ) {
                    enterCellEditSelectMode($(this), select_list_values)
                } else {
                    console.log(`'${$(this).data('column')}' column not supported for editable-select cells edit`)
                    alert(`'${$(this).data('column')}' column not supported for editable-select cells edit`)
                    return 0
                }
            });
            {% endcomment %}

            {% comment %}
            $(document).on("keyup", ".input-data-select", function (e) {
                var key = e.which;
                if (key === 27) { // 27 is the ESC key
                    cancelSelectMode(this);
                }
            });
            {% endcomment %}

            {% comment %}
            $(document).on("change", ".input-data-select", function () {
                if ( ($(this).parent().data('column') == 'PMS') || ($(this).parent().data('column') == 'Class2') ) {
                    sendCellToServer(this, "update_m5_driver_vehicle_data_confirmations", "select")
                    .then(function(promised_data) {
                        td_node = promised_data.td_node
                        api_json_response = promised_data.api_json_response


                        // On api success, update the emp info cells of the modified row in the JS DataTable
                        if ( td_node.data('column') == 'PMS' && td_node.text() == 'None' ) {  // To prevent accessing pms_info['None'], which will cause an error because there's no key 'None' in pms_info object
                            $('[data-id="' + td_node.data('id') + '"][data-table="tblEmployees"][data-column="WU"]').text(          '');
                            $('[data-id="' + td_node.data('id') + '"][data-table="tblEmployees"][data-column="L-Name"]').text(      '');
                            $('[data-id="' + td_node.data('id') + '"][data-table="tblEmployees"][data-column="F-Name"]').text(      '');
                            $('[data-id="' + td_node.data('id') + '"][data-table="tblWorkUnitDivisionJoeSubs"][data-column="SubDivision"]').text( '');
                        }
                        else if ( td_node.data('column') == 'PMS' ) {
                            $('[data-id="' + td_node.data('id') + '"][data-table="tblEmployees"][data-column="WU"]').text(          pms_info[td_node.html()]['wu'] );
                            $('[data-id="' + td_node.data('id') + '"][data-table="tblEmployees"][data-column="L-Name"]').text(      pms_info[td_node.html()]['last_name'] );
                            $('[data-id="' + td_node.data('id') + '"][data-table="tblEmployees"][data-column="F-Name"]').text(      pms_info[td_node.html()]['first_name'] );
                            $('[data-id="' + td_node.data('id') + '"][data-table="tblWorkUnitDivisionJoeSubs"][data-column="SubDivision"]').text( pms_info[td_node.html()]['subdiv'] );
                        }
                    }).catch(promise => {
                        console.log(promise);
                        alert(`Something went wrong when calling sendCellToServer(): ${promise.message}`);
                    });
                } else {
                    console.log(`sendCellToServer() doesn't support '${$(this).parent().data('column')}' column for editable-select cells to sent api call`)
                    alert(`sendCellToServer() doesn't support '${$(this).parent().data('column')}' column for editable-select cells to sent api call`)
                    return 0
                }
            });
            {% endcomment %}

        });
    </script>
{% endblock custom_js %}