{% extends 'OrgChartPortal.template.base.html' %}

{% load static %}

{% block custom_css %}
    <link rel="stylesheet" type="text/css" href="{% static 'PMU_DjangoWebApps/OrgChart/3.1.1/jquery.orgchart.min.css' %}" />
    {% comment %} <style>
        #chartContainerId {
            position: relative;
            height: 420px;
            border: 1px solid #aaa;
            margin: 0.5rem;
            overflow: auto;
            text-align: center;
        }
    </style> {% endcomment %}
{% endblock %}

{% block content %}
    <div class="navbar navbar-expand-lg">
        <h2 class="mt-3">
            Org Chart View
        </h2>
        <div class="status_info err_msg">{% if not req_success %} Error: '{{ err_msg }}'<br>Please try reloading the page again!<br>Please contact ykuang@dot.nyc.gov with a screenshot if this error continues. {% else %}{% endif %}</div>
    </div>


    <div id='chartContainerId'>
    </div>

    <button id="resetInitialMasterOrgChartClick">Reset Org Chart</button>
    <br>
    <select id="PMSSelect">
        <option value="abc">abc</option>
    </select>
    <button id="resetOrgChartWithSelectedPMSClick">Find employee</button>


{% endblock content %}

{% block custom_js %}
    <script type="text/javascript" charset="utf8" src="{% static 'PMU_DjangoWebApps/js/ApiCallWrappers.js' %}"></script>
    <script type="text/javascript" charset="utf8" src="{% static 'PMU_DjangoWebApps/d3js/d3/d3.v7.min.js' %}"></script>
    <script type="text/javascript" charset="utf8" src="{% static 'PMU_DjangoWebApps/d3js/d3-org-chart/d3-org-chart@2.js' %}"></script>
    <script type="text/javascript" charset="utf8" src="{% static 'PMU_DjangoWebApps/d3js/d3-flextree/2.0.0/d3-flextree.js' %}"></script>
    {% comment %} <script type="text/javascript" charset="utf8" src="{% static 'PMU_DjangoWebApps/es6-promise/4.1.1/es6-promise.auto.min.js' %}"></script>
    <script type="text/javascript" charset="utf8" src="{% static 'PMU_DjangoWebApps/html2canvas/1.3.2/html2canvas.min.js' %}"></script>
    <script type="text/javascript" charset="utf8" src="{% static 'PMU_DjangoWebApps/jspdf/2.4.0/jspdf.umd.min.js' %}"></script>
    <script type="text/javascript" charset="utf8" src="{% static 'PMU_DjangoWebApps/OrgChart/3.1.1/jquery.orgchart.min.js' %}"></script> {% endcomment %}
    <script>
        $(document).ready( function () {
            /*
            var emp_data_json_master
            var oc
            var oc_options = {
                'nodeTitle': 'title'
                ,'nodeContent': 'content'
                ,'draggable': true
                ,'pan': true
                ,'zoom': true
                ,'visibleLevel': 3
                ,'exportButton': true
                ,'exportFileextension': 'pdf'
                ,'exportFilename': 'MyOrgChart'
                ,'initCompleted': function($chart) {
                    $('#chartContainerId').scrollLeft( ($('#chartContainerId')[0].scrollWidth - $('#chartContainerId').width())/2 );
                }
            }

            function setInitialMasterOrgChart() {
                $(document).ajaxStart(function () {
                    $("body").addClass("loading");
                })
                .ajaxStop(function () {
                    $("body").removeClass("loading");
                });

                sentJsonBlobToApi( json_blob={}, api_url="{% url 'orgchartportal_get_commissioner_pms' %}", http_request_method="POST",
                    successCallbackFct=function(json_response) {
                        //alert(`data saved successfully!`)

                        let root_pms = json_response.post_data


                        let json_blob = {
                            root_pms: root_pms
                        }

                        sentJsonBlobToApi( json_blob=json_blob, api_url="{% url 'orgchartportal_get_emp_json' %}", http_request_method="POST",
                            successCallbackFct=function(json_response) {
                                //alert(`data saved successfully!`)

                                emp_data_json_master = json_response.post_data

                                let options = {
                                    'data': emp_data_json_master
                                }

                                for (let i in oc_options) {
                                    options[i] = oc_options[i]
                                }

                                oc = $('#chartContainerId').orgchart(options);
                            },
                            failCallbackFct=function(json_response) {
                                alert(JSON.stringify(json_response, null, 2))
                            }
                        )



                    },
                    failCallbackFct=function(json_response) {
                        alert(JSON.stringify(json_response, null, 2))
                    }
                )
            }

            // find the object in the @tree_root that is equal to @lookup. Returns object if found, and null if not found
            function traverseAndFindRootByPMS(tree_root, lookup) {
                if (tree_root['pms'] !== null) {
                    if (tree_root['pms'] == lookup)
                        return tree_root
                }

                for (let i in tree_root['children']) {
                    if (tree_root['children'][i] !== null && typeof(tree_root['children'][i]) == "object") { // Not null and it's a json object
                        //going one step down in the object tree_root!!
                        let child = traverseAndFindRootByPMS(tree_root['children'][i], lookup)
                        if (child !== null)
                            return child
                    }
                }

                return null
            }

            function refreshOrgChart(data) {
                let options = {
                    'data': data
                }

                for (let i in oc_options) {
                    options[i] = oc_options[i]
                }

                oc.init(options)
            }

            setInitialMasterOrgChart()

            $('#resetInitialMasterOrgChartClick').click(function() {
                oc.init(emp_data_json_master)
            })

            $("#resetOrgChartWithSelectedPMSClick").click(function() {
                let pms = $("#PMSSelect").val()
                let root = traverseAndFindRootByPMS(emp_data_json_master, pms)

                if (root == null) {
                    alert(`${pms} not found`)
                } else {
                    refreshOrgChart(root)
                }
            })
            */

            var emp_data_csv_master
            var chart

            function setInitialMasterOrgChart() {
                $(document).ajaxStart(function () {
                    $("body").addClass("loading");
                })
                .ajaxStop(function () {
                    $("body").removeClass("loading");
                });

                sentJsonBlobToApi( json_blob={}, api_url="{% url 'orgchartportal_get_commissioner_pms' %}", http_request_method="POST",
                    successCallbackFct=function(json_response) {
                        //alert(`data saved successfully!`)

                        let root_pms = json_response.post_data


                        let json_blob = {
                            root_pms: root_pms
                        }

                        sentJsonBlobToApi( json_blob=json_blob, api_url="{% url 'orgchartportal_get_emp_csv' %}", http_request_method="POST",
                                successCallbackFct=function(json_response) {
                                    //alert(`data saved successfully!`)

                                    emp_data_csv_master = json_response.post_data

                                    let parsed_csv = d3.csvParse(emp_data_csv_master)

                                    // For reference to what to name your id and parent id column: https://github.com/bumbeishvili/org-chart/issues/88
                                    chart = new d3.OrgChart().nodeId(
                                        d=>d.pms
                                    ).parentNodeId(
                                        d=>d.sup_pms
                                    ).container('#chartContainerId').data(parsed_csv).render();


                                },
                                failCallbackFct=function(json_response) {
                                    alert(JSON.stringify(json_response, null, 2))
                                }
                            )

                    },
                    failCallbackFct=function(json_response) {
                        alert(JSON.stringify(json_response, null, 2))
                    }
                )
            }

            setInitialMasterOrgChart()



        });
    </script>
{% endblock custom_js %}