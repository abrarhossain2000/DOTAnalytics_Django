{% extends 'DailyPothole.template.base.html' %}

{% load static %}
{% load tz %}

{% block custom_css %}
    <!-- You MUST include jQuery before Fomantic -->
    <script src="{% static 'WebAppsMain/js/jquery/3.3.1/jquery.min.js' %}"></script>
    <script src="{% static 'WebAppsMain/fomantic-ui/2.8.7/semantic.min.js' %}"></script>
    <link rel="stylesheet" type="text/css" href="{% static 'WebAppsMain/fomantic-ui/2.8.7/semantic.min.css' %}">

    <link rel="stylesheet" type="text/css" href="{% static 'WebAppsMain/DataTables/datatables.css' %}" />
{% endblock %}

{% block content %}
    <div class="navbar navbar-expand-lg">
        <h2 class="mt-3">
            Daily Pothole Data Grid
        </h2>
        <div class="status_info err_msg">{% if not req_success %} Error: '{{ err_msg }}'<br>Please try reloading the page again!<br>Please contact ykuang@dot.nyc.gov with a screenshot if this error continues. {% else %}{% endif %}</div>
    </div>


    {% if client_is_admin %}
        <table class="table table-striped table-hover" id="JSDataTable">
            <thead>
                <tr>
                    <th>Repair Date</th>
                    <th>Operation</th>
                    <th>Boro</th>
                    <th>Repair Crew Count</th>
                    <th>Holes Repaired</th>
                    <th>Daily Crew Count</th>
                    <th>Last Modified Timestamp</th>
                    <th>Last Modified by</th>
                </tr>
            </thead>

            <body id="JSDataTableBody">
                {% for entry in daily_pothole %}
                <tr>
                    <td data-entryPotholeMasterId="{{ entry.pothole_master_id }}" data-table="tblPotholeMaster" data-column="RepairDate"        >{{ entry.repair_date|date:"Y-m-d"          }}</td>
                    <td data-entryPotholeMasterId="{{ entry.pothole_master_id }}" data-table="tblOperation"     data-column="Operation"         >{{ entry.operation_id__operation            }}</td>
                    <td data-entryPotholeMasterId="{{ entry.pothole_master_id }}" data-table="TblBoro"          data-column="BoroLong"          >{{ entry.boro_id__boro_long                }}</td>
                    <td data-entryPotholeMasterId="{{ entry.pothole_master_id }}" data-table="tblPotholeMaster" data-column="RepairCrewCount"   >{{ entry.repair_crew_count                 }}</td>
                    <td data-entryPotholeMasterId="{{ entry.pothole_master_id }}" data-table="tblPotholeMaster" data-column="HolesRepaired"     >{{ entry.holes_repaired                    }}</td>
                    <td data-entryPotholeMasterId="{{ entry.pothole_master_id }}" data-table="tblPotholeMaster" data-column="DailyCrewCount"    >{{ entry.daily_crew_count                  }}</td>
                    <td data-entryPotholeMasterId="{{ entry.pothole_master_id }}" data-table="tblPotholeMaster" data-column="LastModifiedStamp" >{{ entry.last_modified_stamp|localtime}}</td>
                    <td data-entryPotholeMasterId="{{ entry.pothole_master_id }}" data-table="TblUser"          data-column="Username"          >{{ entry.last_modified_by_user_id__username }}</td>
                </tr>
                {% endfor %}
            </body>
        </table>
    {% endif %}
{% endblock content %}

{% block custom_js %}
    <script type="text/javascript" charset="utf8" src="{% static 'WebAppsMain/DataTables/datatables.js' %}"></script>
    <script type="text/javascript" charset="utf8" src="{% static 'WebAppsMain/js/CellEditSave.js' %}"></script>
    <script type="text/javascript" charset="utf8" src="{% static 'WebAppsMain/js/ApiCallWrappers.js' %}"></script>

    {% comment %} JS Datatable stuff {% endcomment %}
    <script>
        $(document).ready( function () {
            // Reset the default viewport from css class container to container-fluid
            $(".container").attr('class', 'container-fluid')

            $.ajaxSetup({
                beforeSend: function (xhr, settings) {
                    if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                        // Only send the token to relative URLs i.e. locally.
                        xhr.setRequestHeader("X-CSRFToken", Cookies.get('csrftoken'));
                    }
                }
            });

            // Add extra row to the HTML table's header for individual column filtering
            $('#JSDataTable thead tr').clone(true).appendTo( '#JSDataTable thead' );
            $('#JSDataTable thead tr:eq(1) th').each( function (i) {
                var title = $(this).text();
                $(this).html( '<input type="text" placeholder="Search '+title+'" />' );

                $( 'input', this ).on( 'keyup change', function() {
                    if ( table.column(i).search() !== this.value ) {
                        table
                            .column(i)
                            .search( this.value )
                            .draw();
                    }
                });
            } );

            var table = $('#JSDataTable').DataTable({
                dom: 'Blfrtip',  // Look at the documention on the possible options: https://datatables.net/reference/option/dom
                buttons: [
                    {
                        extend: 'csv',
                        text: 'Download as CSV',
                    },
                ],
                orderCellsTop: true,
                fixedHeader: true,
                pageLength: 10,
                lengthMenu: [ 10, 25, 50, 75, 100 ],
                order: [[0, 'desc']]
            });

            {% comment %}
            // For cell select mode
            $(document).on("dblclick", ".editable-select", function () {
                if ( $(this).data('column') == 'PMS' ) {
                    select_list_values = ['None']
                    select_list_values = select_list_values.concat(select_permitted_pms_list)
                } else if ( $(this).data('column') == 'Class2' ) {
                    //select_list_values = ['None', 'Commuter', 'Non-Commuter']
                    select_list_values = ['Commuter', 'Non-Commuter']
                } else {
                    console.log(`'${$(this).data('column')}' column not supported for editable-select cells edit`)
                    alert(`'${$(this).data('column')}' column not supported for editable-select cells edit`)
                    return 0
                }

                // Move current select element to the top of the array
                var current_value = $(this).text()
                select_list_values.sort(function(x, y) {
                    return x == current_value ? -1 : y == current_value ? 1 : 0;
                });


                if ( $(this).data('column') == 'PMS' ) {
                    enterCellEditSelectMode($(this), select_list_values, true, select_permitted_pms_list_additional_info_json, "display additional first")
                } else if ( $(this).data('column') == 'Class2' ) {
                    enterCellEditSelectMode($(this), select_list_values)
                } else {
                    console.log(`'${$(this).data('column')}' column not supported for editable-select cells edit`)
                    alert(`'${$(this).data('column')}' column not supported for editable-select cells edit`)
                    return 0
                }
            });
            {% endcomment %}

            {% comment %}
            $(document).on("keyup", ".input-data-select", function (e) {
                var key = e.which;
                if (key === 27) { // 27 is the ESC key
                    cancelSelectMode(this);
                }
            });
            {% endcomment %}

            {% comment %}
            $(document).on("change", ".input-data-select", function () {
                if ( ($(this).parent().data('column') == 'PMS') || ($(this).parent().data('column') == 'Class2') ) {
                    sendCellToServer(node=this, api_url="update_m5_driver_vehicle_data_confirmations", http_request_method="POST", cell_html_type="select")
                    .then(function(promised_data) {
                        td_node = promised_data.td_node
                        api_json_response = promised_data.api_json_response


                        // On api success, update the emp info cells of the modified row in the JS DataTable
                        if ( td_node.data('column') == 'PMS' && td_node.text() == 'None' ) {  // To prevent accessing pms_info['None'], which will cause an error because there's no key 'None' in pms_info object
                            $('[data-id="' + td_node.data('id') + '"][data-table="tblEmployees"][data-column="WU"]').text(          '');
                            $('[data-id="' + td_node.data('id') + '"][data-table="tblEmployees"][data-column="L-Name"]').text(      '');
                            $('[data-id="' + td_node.data('id') + '"][data-table="tblEmployees"][data-column="F-Name"]').text(      '');
                            $('[data-id="' + td_node.data('id') + '"][data-table="tblWorkUnitDivisionJoeSubs"][data-column="SubDivision"]').text( '');
                        }
                        else if ( td_node.data('column') == 'PMS' ) {
                            $('[data-id="' + td_node.data('id') + '"][data-table="tblEmployees"][data-column="WU"]').text(          pms_info[td_node.html()]['wu'] );
                            $('[data-id="' + td_node.data('id') + '"][data-table="tblEmployees"][data-column="L-Name"]').text(      pms_info[td_node.html()]['last_name'] );
                            $('[data-id="' + td_node.data('id') + '"][data-table="tblEmployees"][data-column="F-Name"]').text(      pms_info[td_node.html()]['first_name'] );
                            $('[data-id="' + td_node.data('id') + '"][data-table="tblWorkUnitDivisionJoeSubs"][data-column="SubDivision"]').text( pms_info[td_node.html()]['subdiv'] );
                        }
                    }).catch(promise => {
                        console.log(promise);
                        alert(`Something went wrong when calling sendCellToServer(): ${promise.message}`);
                    });
                } else {
                    console.log(`sendCellToServer() doesn't support '${$(this).parent().data('column')}' column for editable-select cells to sent api call`)
                    alert(`sendCellToServer() doesn't support '${$(this).parent().data('column')}' column for editable-select cells to sent api call`)
                    return 0
                }
            });
            {% endcomment %}
        });
    </script>
{% endblock custom_js %}