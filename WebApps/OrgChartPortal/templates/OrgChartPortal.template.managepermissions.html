{% extends 'OrgChartPortal.template.base.html' %}

{% load static %}

{% block custom_css %}
    <link rel="stylesheet" type="text/css" href="{% static 'WebAppsMain/AGGrid/v26.2.1/ag-grid.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'WebAppsMain/AGGrid/v26.2.1/ag-theme-alpine.css' %}">

    <style>
        /* Dimming the notEditableColorCode column */
        .notEditableColorCode {
            background-color: lightgrey;
        }
    </style>
{% endblock %}

{% block content %}
    <div class="ui floating big message">
        <h2>
            Manage Permissions
        </h2>
        <div class="status_info err_msg">{% if not req_success %} Error: '{{ err_msg }}'<br>Please try reloading the page again!<br>Please contact ykuang@dot.nyc.gov with a screenshot if this error continues. {% else %}{% endif %}</div>
    </div>

    {% if client_is_admin %}
        <!-- Add new row button and modal form -->
        <div class="ui one column centered grid">
            <div class="ui modal" id="modalNewRowForm">
                <div class="content center aligned">

                    <div class="ui horizontal divider">Add new user permission</div>

                    <div>User</div>
                    <div id="modalNewRowFormSelectUserInputBorder" class="ui input">
                        <select id="modalNewRowFormSelectUserInput" class="ui selection dropdown">
                            <option value=""></option>
                            {% for each in user_list %}
                                <option value="{{ each }}">{{ each }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div>Division</div>
                    <div id="modalNewRowFormSelectDivisionInputBorder" class="ui input">
                        <select id="modalNewRowFormSelectDivisionInput" class="ui selection dropdown">
                            <option value=""></option>
                            {% for each in division_list %}
                                <option value="{{ each }}">{{ each }}</option>
                            {% endfor %}
                        </select>
                    </div>


                    <div class="ui horizontal divider">-</div>
                    <button id="modalNewRowFormAddButton" class="ui teal large button">Add new user permission</button>

                </div>
                <div id='successMsg'></div>
            </div>

            <button id="trigger_input" class="ui teal large button">Add new user permission</button>
        </div>


        <!--admin access control web grid-->
        <div style="height: 40vw; width: auto;">
            <div id="AGGrid" class="ag-theme-alpine" style="height: 100%; width: 100%;"></div>
        </div>
        <!--End admin access control web grid-->
    {% endif %}
{% endblock content %}

{% block custom_js %}
    <script type="text/javascript" charset="utf8" src="{% static 'WebAppsMain/AGGrid/v26.2.1/ag-grid-community.min.noStyle.js' %}"></script>
    <script type="text/javascript" charset="utf8" src="{% static 'WebAppsMain/js/AGGridCustomExtensions.js' %}" type=""></script>
    <script type="text/javascript" charset="utf8" src="{% static 'WebAppsMain/js/ApiCallWrappers.js' %}"></script>

    <script>
        $(document).ready( function () {
            // Initializing the existing select divs into a dropdown menu for Formantic UI
            $('#modalNewRowFormSelectUserInput').dropdown();
            $('#modalNewRowFormSelectDivisionInput').dropdown();

            if ( document.getElementById('trigger_input') != null ) {
                document.getElementById('trigger_input').addEventListener("click", function() {
                    $('#modalNewRowForm').modal('show')
                });
            } else {
                alert(`Cannot find a div with the ID 'trigger_input'`)
            }

            function onFirstDataRendered(params) {
                params.api.sizeColumnsToFit();
            }

            var col_def = {{ ag_grid_col_def_json|safe }};
            var data    = {{ permissions_json|safe }};

            for (col_i in col_def) {
                ag_column = col_def[col_i];

                if (ag_column.headerName == 'Delete?') {
                    ag_column['cellRenderer']   = 'deleteCellRenderer';
                }
            }

            var gridOptions = {
                // PROPERTIES
                // Objects like myRowData and myColDefs would be created in your application
                //getRowNodeId: (data) => data.windows_username,
                columnDefs: col_def,
                rowData: data,
                domLayout: 'normal',

                defaultColDef: {
                    sortable: true,
                    filter: true,
                    resizable: true,
                },

                onFirstDataRendered: onFirstDataRendered,
                enableCellChangeFlash: true,
                rowSelection: 'single',

                stopEditingWhenCellsLoseFocus: true,
                components: {
                    deleteCellRenderer  : DeleteCellRenderer,
                },
            }

            const gridDiv = document.getElementById('AGGrid');
            new agGrid.Grid(gridDiv, gridOptions);


            $('#AGGrid').on("click", ".deletable", function() {
                // only 1 row is returned due to rowSelection: 'single' in gridOptions
                const selected_row = gridOptions.api.getSelectedRows()[0];

                if (confirm(`Are you sure you want to delete ('${selected_row.user_id__windows_username}' - '${selected_row.wu__wu}')?`)) {
                    json_blob = {
                        'windows_username'  : selected_row.user_id__windows_username,
                        'delete_by'         : 'wu',
                        'wu'                : selected_row.wu__wu
                    }

                    sentJsonBlobToApi({
                        json_blob           : json_blob,
                        api_url             : "{% url 'orgchartportal_delete_user_permission' %}",
                        http_request_method : "POST",
                        successCallbackFct  : function(json_response) {
                                                alert(`('${json_response.windows_username}' - '${json_response.wu}') removed successfully!`);
                                                gridOptions.api.applyTransaction({ remove: [selected_row] });
                                                return;
                                            }
                    })
                }

            });


            // For row add, with support for only JS Datatable
            $('#modalNewRowFormAddButton').on("click", function() {
                let user    = $("#modalNewRowFormSelectUserInput").val();
                let subdiv  = $("#modalNewRowFormSelectDivisionInput").val();

                $('#modalNewRowFormSelectUserInputBorder').css("border", "");
                $('#modalNewRowFormSelectDivisionInputBorder').css("border", "");


                if (user == '') {
                    alert(`User cannot be empty`);
                    $('#modalNewRowFormSelectUserInputBorder').css("border", "2px solid red");
                    return;
                }

                if (subdiv == '') {
                    alert(`Division cannot be empty`);
                    $('#modalNewRowFormSelectDivisionInputBorder').css("border", "2px solid red");
                    return;
                }

                json_blob = {
                    "windows_username"  : user,
                    "add_by"            : 'division',
                    "subdiv"            : subdiv,
                }

                sendModalFormDataToServer( json_blob=json_blob, api_url="{% url 'orgchartportal_add_user_permission' %}", http_request_method="POST",
                    successCallbackFct=function(json_response) {
                        alert(`'${json_response.windows_username}' - '${json_response.subdiv}' Work Unit Permissions added successfully!`);
                        //@TODO
                        console.log(json_response)
                        //gridOptions.api.applyTransaction({
                        //    add     : [{
                        //                pms             : json_response.pms,
                        //                windows_username: json_response.windows_username,
                        //                is_admin        : json_response.is_admin.toLowerCase(),
                        //                active          : 'true'
                        //            }],
                        //    addIndex: 0
                        //});
                        return;
                    }
                )
            })

        });
    </script>
{% endblock custom_js %}