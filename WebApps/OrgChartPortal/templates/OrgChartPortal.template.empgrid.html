{% extends 'OrgChartPortal.template.base.html' %}

{% load static %}

{% block custom_css %}
    <!-- You MUST include jQuery before Fomantic -->
    <script src="{% static 'WebAppsMain/js/jquery/3.3.1/jquery.min.js' %}"></script>
    <script src="{% static 'WebAppsMain/fomantic-ui/2.8.7/semantic.min.js' %}"></script>
    <link rel="stylesheet" type="text/css" href="{% static 'WebAppsMain/fomantic-ui/2.8.7/semantic.min.css' %}">

    <!-- <link rel="stylesheet" type="text/css" href="{% static 'WebAppsMain/DataTables/datatables.css' %}" /> -->
    <link rel="stylesheet" type="text/css" href="{% static 'WebAppsMain/AGGrid/v26.2.1/ag-grid.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'WebAppsMain/AGGrid/v26.2.1/ag-theme-alpine.css' %}">

    <style>
        /* This is needed to allow AG Grid's css percentage height to work. Reason being that its parent div must also have a percentage height to contain it correctly, otherwise AG Grid will collapse to nothing */
        .container-fluid {
            height: 80%;
        }
    </style>
{% endblock %}

{% block content %}
    <div class="navbar navbar-expand-lg">
        <h2 class="mt-3">
            Org Chart Portal
        </h2>
        <div class="status_info err_msg">{% if not req_success %} Error: '{{ err_msg }}'<br>Please try reloading the page again!<br>Please contact ykuang@dot.nyc.gov with a screenshot if this error continues. {% else %}{% endif %}</div>
    </div>

    {% comment %} Side Bar {% endcomment %}
    {% comment %} <div>
        <div class="ui secondary labeled icon toggle button" id="left-sidebar-toggle">
            <i class="left arrow icon"></i>
            Show my profile (Hide/Show)
        </div>
        <div class="ui inverted left vertical sidebar menu">
            <div id='client_wu_permissions_info'>
                <p class='active item'>My WU Permissions</p>
            </div>

            <div id='client_data_entry_team_info'>
                <p class='active item'>My Data Entry Team</p>
            </div>

            <p class="active item">*To add someone to your data entry team, please email: <br>** Max Siegel<br>(msiegel@dot.nyc.gov) or <br>** Yi Zong Kuang<br>(ykuang@dot.nyc.gov)</p>
        </div>
    </div> {% endcomment %}

    {% comment %} AG Grid {% endcomment %}
    <div id="AGGrid" class="ag-theme-alpine" style="height: 100%; width: 100%;"></div>

    {% comment %} Footer {% endcomment %}
    {% comment %} <div>
        <div>Supervisor Field Complete</div>
        <div>OfficeTitle Field Complete</div>
        <div>Refresh button??? or just ask user to refresh page?</div>
        <div>Last Time List's Been Updated:</div>
        <div>List Last Updated By:</div>
        <div>Inactive Supervisor Stuff</div>
        <div>Empty or Invalid Floor Combination with WorkLocation: Floor needs updating</div>
        <div>Empty or Invalid SiteType Combination with WorkLocation and Floor: SiteType needs updating</div>
    </div> {% endcomment %}

{% endblock content %}

{% block custom_js %}
    <script type="text/javascript" charset="utf8" src="{% static 'WebAppsMain/DataTables/datatables.js' %}"></script>
    <script type="text/javascript" charset="utf8" src="{% static 'WebAppsMain/js/CellEditSave.js' %}"></script>
    <script type="text/javascript" charset="utf8" src="{% static 'WebAppsMain/js/ApiCallWrappers.js' %}"></script>
    <script type="text/javascript" charset="utf8" src="{% static 'WebAppsMain/AGGrid/v26.2.1/ag-grid-community.min.noStyle.js' %}"></script>

    {% comment %} AG Grid stuff {% endcomment %}
    <script>
        var emp_col_def     = {{ emp_entry_columns_json|safe }};
        var emp_data        = {{ emp_entries_json|safe }};
        var sup_dropdown    = {{ supervisor_dropdown_list_json|safe }}; // It's very important that this list is unique by pms!
        // Add a dummy object for empty superivor full name in the sort of the select list
        sup_dropdown.push({'pms': null, 'annotated__full_name': null})

        var sup_name_from_pms = {};
        for (const i in sup_dropdown) { sup_name_from_pms[sup_dropdown[i].pms] = sup_dropdown[i].annotated__full_name }

        class SupervisorRenderer {
            init(params) {
                let sup_pms         = params.value
                let sup_fullname    = sup_name_from_pms[sup_pms]
                this.eGui = document.createElement('div');
                this.eGui.innerHTML = sup_fullname;
            }

            getGui() {
                return this.eGui;
            }
        }

        class SupervisorEditor {
            init(params) {
                this.value = params.value;
                var select_array = sup_dropdown;

                // Reset select list's sort to sort by alphabet
                select_array.sort(function(x, y) {
                    if (x.pms == null && y.pms == null)   { return 0; }
                    if (x.pms == null)                    { return -1; }
                    if (y.pms == null)                    { return 1; }

                    let x_fullname = sup_name_from_pms[x.pms].toUpperCase();
                    let y_fullname = sup_name_from_pms[y.pms].toUpperCase();

                    return x_fullname < y_fullname ? -1 : x_fullname > y_fullname ? 1 : 0;
                });

                // Bring current selection to top of the select list
                select_array.sort(function(x, y) {
                    return x.pms == params.value ? -1 : y.pms == params.value ? 1 : 0;
                });

                this.select = document.createElement('select');
                select_array.forEach( (each) => {
                    var option = document.createElement('option');
                    option.value = (each.pms == null) ? '' : each.pms;
                    option.text = `${each.annotated__full_name} | ${each.pms}`;
                    this.select.appendChild(option);
                });
                this.select.id = 'sup_select';

                this.select.addEventListener('input', (event) => {
                    // Javascript null = html empty string '', and since event.target.value is an HTML value, '' will be considered as null
                    this.value = (event.target.value == '') ? '' : event.target.value;
                    params.stopEditing();
                });
            }

            /* Component Editor Lifecycle methods */
            // gets called once when grid ready to insert the element
            getGui() { return this.select; }

            // the final value to sent to the grid, on completion of editing
            getValue() { return this.value; }

            // gets called once before editing starts, to give editor a chance to cancel the editing before it even starts
            isCancelBeforeStart() { return false; }

            // gets called once when editing is finished (eg if Enter is pressed)
            // if you return true, then the result of the edit will be ignored
            isCancelAfterEnd() { return false; }

            // after this component has been created and inserted into the grid
            afterGuiAttached() { this.select.focus(); }
        }

        document.addEventListener("DOMContentLoaded", function(event) {
            // Reset the default viewport from css class container to container-fluid
            nodes = document.getElementsByClassName('container')
            for (i=0; i<nodes.length; ++i) {
                nodes[i].setAttribute('class', 'container-fluid')
            }

            $.ajaxSetup({
                beforeSend: function (xhr, settings) {
                    if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                        // Only send the token to relative URLs i.e. locally.
                        xhr.setRequestHeader("X-CSRFToken", Cookies.get('csrftoken'));
                    }
                }
            });


            // Specify the columns that is editable here
            var editable_column_names = {
                'Supervisor'        : 'Select',
                'OfficeTitle'       : 'Input',
                'ActualSite'        : 'Input',
                'ActualFloor'       : 'Input',
                'ActualSiteType'    : 'Input',
            }

            // Add a generic cell edit function to all editable cells
            for (col_i in emp_col_def) {
                ag_column = emp_col_def[col_i]

                if ( Object.keys(editable_column_names).includes(ag_column.headerName) ) {
                    ag_column['editable'] = true;

                    // Attached a class for creating a select dropdown list for any columns that contains values from a dropdown list
                    if (editable_column_names[ag_column.headerName] === 'Select') {
                        ag_column['cellEditor']     = 'supervisorCellEditor';
                        ag_column['cellRenderer']   = 'supervisorCellRenderer';
                    }
                }
            }

            var gridOptions = {
                // PROPERTIES
                // Objects like myRowData and myColDefs would be created in your application
                getRowNodeId: (data) => data.pms,
                columnDefs: emp_col_def,
                rowData: emp_data,
                domLayout: 'normal',

                defaultColDef: {
                    sortable: true,
                    filter: true
                },

                stopEditingWhenCellsLoseFocus: true,
                components: {
                    supervisorCellEditor    : SupervisorEditor,
                    supervisorCellRenderer  : SupervisorRenderer,
                },
            }

            const gridDiv = document.getElementById('AGGrid');
            new agGrid.Grid(gridDiv, gridOptions);


            /*
            // For cell select mode
            $(document).on("dblclick", ".editable-select", function () {
                if ( $(this).data('column') == 'PMS' ) {
                    select_list_values = ['None']
                    select_list_values = select_list_values.concat(select_permitted_pms_list)
                } else if ( $(this).data('column') == 'Class2' ) {
                    //select_list_values = ['None', 'Commuter', 'Non-Commuter']
                    select_list_values = ['Commuter', 'Non-Commuter']
                } else {
                    console.log(`'${$(this).data('column')}' column not supported for editable-select cells edit`)
                    alert(`'${$(this).data('column')}' column not supported for editable-select cells edit`)
                    return 0
                }

                // Move current select element to the top of the array
                var current_value = $(this).text()
                select_list_values.sort(function(x, y) {
                    return x == current_value ? -1 : y == current_value ? 1 : 0;
                });


                if ( $(this).data('column') == 'PMS' ) {
                    enterCellEditSelectMode($(this), select_list_values, true, select_permitted_pms_list_additional_info_json, "display additional first")
                } else if ( $(this).data('column') == 'Class2' ) {
                    enterCellEditSelectMode($(this), select_list_values)
                } else {
                    console.log(`'${$(this).data('column')}' column not supported for editable-select cells edit`)
                    alert(`'${$(this).data('column')}' column not supported for editable-select cells edit`)
                    return 0
                }
            });

            $(document).on("keyup", ".input-data-select", function (e) {
                var key = e.which;
                if (key === 27) { // 27 is the ESC key
                    cancelSelectMode(this);
                }
            });

            $(document).on("change", ".input-data-select", function () {
                if ( ($(this).parent().data('column') == 'PMS') || ($(this).parent().data('column') == 'Class2') ) {
                    sendCellToServer(node=this, api_url="update_m5_driver_vehicle_data_confirmations", http_request_method="POST", cell_html_type="select")
                    .then(function(promised_data) {
                        td_node = promised_data.td_node
                        api_json_response = promised_data.api_json_response


                        // On api success, update the emp info cells of the modified row in the JS DataTable
                        if ( td_node.data('column') == 'PMS' && td_node.text() == 'None' ) {  // To prevent accessing pms_info['None'], which will cause an error because there's no key 'None' in pms_info object
                            $('[data-id="' + td_node.data('id') + '"][data-table="tblEmployees"][data-column="WU"]').text(          '');
                            $('[data-id="' + td_node.data('id') + '"][data-table="tblEmployees"][data-column="L-Name"]').text(      '');
                            $('[data-id="' + td_node.data('id') + '"][data-table="tblEmployees"][data-column="F-Name"]').text(      '');
                            $('[data-id="' + td_node.data('id') + '"][data-table="TblWorkUnits"][data-column="SubDivision"]').text( '');
                        }
                        else if ( td_node.data('column') == 'PMS' ) {
                            $('[data-id="' + td_node.data('id') + '"][data-table="tblEmployees"][data-column="WU"]').text(          pms_info[td_node.html()]['wu'] );
                            $('[data-id="' + td_node.data('id') + '"][data-table="tblEmployees"][data-column="L-Name"]').text(      pms_info[td_node.html()]['last_name'] );
                            $('[data-id="' + td_node.data('id') + '"][data-table="tblEmployees"][data-column="F-Name"]').text(      pms_info[td_node.html()]['first_name'] );
                            $('[data-id="' + td_node.data('id') + '"][data-table="TblWorkUnits"][data-column="SubDivision"]').text( pms_info[td_node.html()]['subdiv'] );
                        }
                    }).catch(promise => {
                        console.log(promise);
                        alert(`Something went wrong when calling sendCellToServer(): ${promise.message}`);
                    });
                } else {
                    console.log(`sendCellToServer() doesn't support '${$(this).parent().data('column')}' column for editable-select cells to sent api call`)
                    alert(`sendCellToServer() doesn't support '${$(this).parent().data('column')}' column for editable-select cells to sent api call`)
                    return 0
                }
            });
            */

        });
    </script>

    {% comment %} Side Bar Stuff {% endcomment %}
    {% comment %} <script>
        function upperCaseFirstLetter(string) {
            return string.charAt(0).toUpperCase() + string.slice(1);
        }

        function lowerCaseAllWordsExceptFirstLetters(string) {
            return string.replace(/\S*/g, function (word) {
                return word.charAt(0) + word.slice(1).toLowerCase();
            });
        }

        $(document).ready( function () {
             $('.ui.left.sidebar').sidebar({
                dimPage: false,
                transition: 'push',
                exclusive: false,
                closable: false
            });

            $('.ui.left.sidebar')
            .sidebar('attach events', '#left-sidebar-toggle');

            // Get permitted WU permissions info
            $.ajax({
                url: "/OrgChartPortal/get_client_wu_permissions_list",
                type: "POST",
            })
            .done(function(json_response) {
                if (json_response["post_success"] == false) {
                    console.log(`Error: Ajax calling GetClientWUPermissions: Server Response: ${json_response["post_msg"]}`);
                    alert(`Something went wrong while trying to get list WU permissions for client.\nPlease contact ykuang@dot.nyc.gov if this error continues:\n\nAjax calling get_client_wu_permissions_list: Server Response: ${json_response["post_msg"]}`);
                } else { // Api call successful
                    list_of_json_client_wu_permissions_response = json_response["post_data"]

                    // Populate side bar
                    list_of_json_client_wu_permissions_response.map(function(each) {
                        $('#client_wu_permissions_info').append(`<p class='item'>WU - ${each.wu__wu}<br>${each.wu__wu_desc}<br>${each.wu__subdiv}</p>`)
                    })

                }
                return true;
            })
            .fail(function(json_response) {
                var errorMessage = `Server might be down, try to reload the web page to confirm. Otherwise, try again and if error is still happening, contact ykuang@dot.nyc.gov\n xhr response: ${jqXHR.status}\n xhr response text: ${jqXHR.responseText}`;
                console.log(`Ajax Post: Error Occured: ${errorMessage}`);
                alert(`Ajax Post: Error Occured:\n\n${errorMessage}`);
                return false;
            });

            // Get teammates info
            $.ajax({
                url: "/OrgChartPortal/get_client_teammates_list",
                type: "POST",
            })
            .done(function(json_response) {
                if (json_response["post_success"] == false) {
                    console.log(`Error: Ajax calling GetClientTeammates: Server Response: ${json_response["post_msg"]}`);
                    alert(`Something went wrong while trying to get list teammates for client.\nPlease contact ykuang@dot.nyc.gov if this error continues:\n\nAjax calling get_client_teammates_list: Server Response: ${json_response["post_msg"]}`);
                } else { // Api call successful
                    list_of_json_client_teammates_response = json_response["post_data"]

                    // Populate side bar
                    list_of_json_client_teammates_response.map(function(each) {
                        let first_name = upperCaseFirstLetter(lowerCaseAllWordsExceptFirstLetters(each.pms__first_name))
                        let last_name = upperCaseFirstLetter(lowerCaseAllWordsExceptFirstLetters(each.pms__last_name))
                        $('#client_data_entry_team_info').append(`<p class='item'>${first_name}, ${last_name}</p>`)
                    })

                }
                return true;
            })
            .fail(function(json_response) {
                var errorMessage = `Server might be down, try to reload the web page to confirm. Otherwise, try again and if error is still happening, contact ykuang@dot.nyc.gov\n xhr response: ${jqXHR.status}\n xhr response text: ${jqXHR.responseText}`;
                console.log(`Ajax Post: Error Occured: ${errorMessage}`);
                alert(`Ajax Post: Error Occured:\n\n${errorMessage}`);
                return false;
            });

            // Get emp grid stats
            $.ajax({
                url: "/OrgChartPortal/get_emp_grid_stats",
                type: "POST",
            })
            .done(function(json_response) {
                if (json_response["post_success"] == false) {
                    console.log(`Error: Ajax calling GetEmpGridStats: Server Response: ${json_response["post_msg"]}`);
                    alert(`Something went wrong while trying to get emp grid stats for client.\nPlease contact ykuang@dot.nyc.gov if this error continues:\n\nAjax calling get_emp_grid_stats: Server Response: ${json_response["post_msg"]}`);
                } else { // Api call successful
                    list_of_json_client_emp_grid_stats_response = json_response["post_data"]

                    console.log('Dev purpose: GetEmpGridStats: ')
                    console.log(list_of_json_client_emp_grid_stats_response)
                }
                return true;
            })
            .fail(function(json_response) {
                var errorMessage = `Server might be down, try to reload the web page to confirm. Otherwise, try again and if error is still happening, contact ykuang@dot.nyc.gov\n xhr response: ${jqXHR.status}\n xhr response text: ${jqXHR.responseText}`;
                console.log(`Ajax Post: Error Occured: ${errorMessage}`);
                alert(`Ajax Post: Error Occured:\n\n${errorMessage}`);
                return false;
            });
        });
    </script> {% endcomment %}

    {% comment %} Footer Stuff {% endcomment %}

{% endblock custom_js %}